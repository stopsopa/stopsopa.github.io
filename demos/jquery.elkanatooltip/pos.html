<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="//jquery.com/jquery-wp-content/themes/jquery/js/jquery-1.11.2.min.js"><\/script>')</script>
    <script type="text/javascript" src="jquery.line.js"></script>
    <script type="text/javascript" src="../../js/underscore.js"></script>
    <script type="text/javascript">
        function log(l) {try{console.log(l)}catch(e){}};
        function json(l) {log(JSON.stringify(l))};

        $(function () {
            /**
             * Relative to document, od krawędzi bordera do dokuemntu
             * niezależnie jakiem marginy czy paddingi sa gdziekolwiek
             * nieważne też czy obiekt znajduje się w body bezpośredio
             * czy też jest w jakimś pośrednim relative
             */
            function docpos(element) { // .offset() based
                var t = $(element).first();

                t.addClass('red');
                
                if (!t.length)
                    throw "No elemen selected";

                var
                    o = t.offset(),
                    k = {
                        l: o.left,
                        t: o.top
                    }

                k.r = k.l + t.outerWidth(false);
                k.b = k.t + t.outerHeight(false);

                return k;
            };
            
            function relativeToDocument(x, y) {
                
            }
            
            // count angle in radians
            function calcAngleRad(x1, y1, x2, y2) {
                return Math.atan2( (y2 - y1) , (x2 - x1) );
            }
            // count angle in degrees
            function calcAngle(x1, y1, x2, y2) {
                var a = calcAngleRad(x1, y1, x2, y2) * (180 / Math.PI); 
                return (a < 0) ? (a += 360) : a;
            }
            
            
            var target = $('#absrel2');
            ;(function () {
                var tol = 20
                var last = false;
                
                var thr = 
//                        _.throttle(
                        function (e, m, p, c, avg, inside) {
                    
                    if (last) {
                        m = {
                            x : e.pageX,
                            y : e.pageY
                        };
                        p = docpos(target);
                        c = {};
                        inside = (m.x >= p.l && m.x <= p.r && m.y >= p.t && m.y <= p.b);

                        if (!inside) {
    //                        var a  = calcAngle(m.x, m.y, p.l + ((p.r - p.l) / 2), p.t + ((p.b - p.t) / 2)); // avarage
                            var k = [];
                            k.push(calcAngle(m.x, m.y, p.l, p.t));
                            k.push(calcAngle(m.x, m.y, p.r, p.t));
                            k.push(calcAngle(m.x, m.y, p.l, p.b));
                            k.push(calcAngle(m.x, m.y, p.r, p.b));
                            k.sort(function(a, b){return a-b})

                            c = {
                                l : k[0],
                                r : k[3]
                            }
//                            log('control')
//                            log(last)
//                            log(m)
                            var ee = calcAngle(last.x, last.y, m.x, m.y);
//                            log('e: '+ee)
                            if ( Math.abs(c.l - c.r) > 180 ) {
                                c.jest = Math.abs(c.l - c.r);
//                                log('nie wiem')
//                                var uu = c.l;
//                                c.l = c.r;
//                                c.r = uu;
//                                c.r -= 360;
                                if (c.l + tol >= ee || c.r - tol <= ee) {
                                    target.addClass('red');
                                    json('tak 1');   
                                }
                                else {
                                    target.removeClass('red');
                                    log('nie 1');
                                }   
                            }
                            else {
                                if (c.l - tol <= ee && c.r + tol >= ee) {
                                    json('tak 2');  
                                    target.addClass('red');                          
                                }
                                else {
                                    log('nie 2');
                                    target.removeClass('red');
                                }                                
                            }
//                            c.e = ee;
//                            json(c)
                        }                        
                    }
                    else {
                        log('init');
                    }
                    
                    last = {
                        x : e.pageX,
                        y : e.pageY
                    };
                    
                }
//                ,200);
                
                
                $(document).on('mousemove', thr);
//                $(document).on('click', thr);
         
            })();
            
            
            json(docpos(target));       
            
        })
    </script>
    <style type="text/css">
        .red {
            color: red !important;
            border-color: red !important;
        }
        body {
            border: 13px black solid;
            margin: 20px;
            padding: 40px;
        }
        #rel {
            position: relative;
            margin: 40px;
            padding: 45px;
            border: 25px black solid;
        }
        #abs {
            position: absolute;
            left: 200px;
            top: 150px;
        }
        #absrel2,
        #absrel,
        #abs,
        #test {
            border: 10px solid silver;
            color: #333;
            padding: 15px 30px;
            margin: 25px;
        }
        #absrel2,
        #absrel {
            position: absolute;
            top: 150px;
            left: 450px;
        }
    </style>
</head>
<body>
    <span id="test">test</span>
    <span id="abs">abs</span>
    <div id="rel">
        <span id="absrel">absrel</span>
    </div>
    <div id="rel">
        <div id="rel">
            <span id="absrel2">absrel2</span>
        </div>
    </div>
</body>
</html>