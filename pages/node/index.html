<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>stopsopa.github.io</title>
    <script src="/js/github.js"></script>
</head>
<body class="layout" toc>

    <div class="body">
        <div class="inside">

            <div class="cards">
                <h2>UMD (Universal Module Definition)</h2>
                <a href="https://github.com/umdjs/umd#tooling">https://github.com/umdjs/umd#tooling</a>
                <h2>Installation on linux</h2>      
                <a href="https://github.com/nodesource/distributions#installation-instructions-1">Installation nodesource</a>
            </div>

            <div class="cards">
                <h2>safe console.log</h2>
                <script type="editor" data-lang="js">

// just log
var log=(function(){try{return console.log}catch(e){return function(){}}}());

// tlog
const tlog = (function () {

    var log=(function(){try{return console.log}catch(e){return function(){}}}());

    const time = () => (new Date()).toISOString().substring(0, 19).replace('T', ' ')

    return (...args) => {
        log.call(this, time(), ...args.map(a => a + ''));
    }
}());

// module
const log=(function(){try{return console.log}catch(e){return function(){}}}());

const time = () => (new Date()).toISOString().substring(0, 19).replace('T', ' ')

module.exports = (...args) => {
    log.call(this, time(), ...args.map(a => a + ''));
}

// node inspect
const i = require('util').inspect;

console.log(i(t, {
    depth:  50,
    colors: true,
    compact: true,
    // breakLength: 80,
}))

                </script>
                <h2>jest</h2>
                <a href="https://github.com/stopsopa/roderic-legacy/tree/master/test/jest">https://github.com/stopsopa/roderic-legacy/tree/master/test/jest</a>

                <h2>update.sh - shell script</h2>               
                <script type="editor" data-lang="sh">


#!/bin/bash

set -e

set -x

ORIGIN="origin"
LOCALBRANCH="master"
REMOTEBRANCH="master"

trim() {
    local var="$*"
    # remove leading whitespace characters
    var="${var#"${var%%[![:space:]]*}"}"
    # remove trailing whitespace characters
    var="${var%"${var##*[![:space:]]}"}"
    echo -n "$var"
}

function red {
    printf "\e[31m$1\e[0m\n"
}

function green {
    printf "\e[32m$1\e[0m\n"
}

if [ "$(git rev-parse --abbrev-ref HEAD)" != $LOCALBRANCH ]; then

    red "switch first branch to <$LOCALBRANCH>"

    exit 1;
fi

green "\ncurrent branch: $LOCALBRANCH";

DIFF="$(git diff --numstat)"

DIFF="$(trim "$DIFF")"

if [ "$DIFF" != "" ]; then

    red "\n\n    Error: First commit changes ...\n\n";

    exit 2;
fi

DIFF="$(git diff --numstat $LOCALBRANCH $ORIGIN/$REMOTEBRANCH)"

DIFF="$(trim "$DIFF")"

if [ "$DIFF" != "" ]; then

    git push $ORIGIN $REMOTEBRANCH --tags

    if [ "$?" != "0" ]; then

        red "\n\nCan't git push - stop bumping version\n"

        exit 3;
    fi

    npm version patch

                            # node version-dep.js
                            # git add package.json
                            # git commit --amend --no-edit

    git push $ORIGIN $REMOTEBRANCH

    if [ "$?" = "0" ]; then

        npm publish

        if [ "$?" != "0" ]; then

            red "\n\nCan't npm publish\n"

            exit 4;
        fi

        git push --tags --force

    else

        red "\n\nCan't git push\n"

        exit 5
    fi

else

    red "\n\n    Nothing new to publish\n\n";
fi

                </script>
            </div>
            <div class="cards">
                <h2>Node clock controlled crush</h2>
                <script type="editor" data-lang="js">

/*

usage in server script:

require('dotenv-up')({
  override    : false,
  deep        : 5,
}, false, '..................');

(function () {

  const atomclock = require('./app/lib/atomclock');

  atomclock.crashServer(process.env.PROTECTED_MYSQL_MAX_TIME_DIFF);
}());

*/

const log = require('inspc');

const jsonfetch = require('./jsonfetch');

const promiseany = require('nlab/promiseany');

// const promiseall = require('nlab/promiseall');

const emsg = msg => `atomclock.js error: ${msg}`

const th = msg => new Error(emsg(msg));

// module.exports = (warning = true) => promiseall([
const tool = (warning = true) => promiseany([
  async atom => {

    try {

      atom = await jsonfetch('http://worldtimeapi.org/api/timezone/Etc/UTC', {
        timeout: 2000,
      });

      if ( ! Number.isInteger(atom.body.unixtime) ) {

        throw th(`http://worldtimeapi.org/api/timezone/Etc/UTC unixtime is not an integer`);
      }

      return atom.body.unixtime;

    }
    catch (e) {

      if (warning) {

        log.dump({
          atomclick_js_warning: e
        })
      }

      throw e;
    }
  },
  async atom => {

    try {

      atom = await jsonfetch('http://showcase.api.linx.twenty57.net/UnixTime/tounixtimestamp?datetime=now', {
        timeout: 2000,
      });

      if (atom.status !== 200) {

        throw th(`http://showcase.api.linx.twenty57.net/UnixTime/tounixtimestamp?datetime=now atom.status !== 200`);
      }

      if ( ! /^\d+$/.test(atom.body.UnixTimeStamp) ) {

        throw th(`http://showcase.api.linx.twenty57.net/UnixTime/tounixtimestamp?datetime=now atom.body.UnixTimeStamp don't match /^\\d+$/`);
      }

      atom = parseInt(atom.body.UnixTimeStamp, 10);

      if ( ! Number.isInteger(atom) ) {

        throw th(`http://showcase.api.linx.twenty57.net/UnixTime/tounixtimestamp?datetime=now atom is not an integer`);
      }

      return atom;

    }
    catch (e) {

      if (warning) {

        log.dump({
          atomclick_js_warning: e
        })
      }

      throw e;
    }
  },
  async atom => {

    try {

      atom = await jsonfetch('http://widget.time.is/', {
        timeout: 2000,
      });

      if (atom.status !== 200) {

        throw th(`http://worldclockapi.com/api/json/utc/now atom.status !== 200`);
      }

      atom = atom.body.replace(/^[^\d]+(\d+).*$/, '$1');

      if ( ! /^\d+$/.test(atom) ) {

        throw th(`http://worldclockapi.com/api/json/utc/now atom.status don't match /^\\d+$/`);
      }

      return parseInt(parseInt(atom, 10) / 1000, 10);

    }
    catch (e) {

      if (warning) {

        log.dump({
          atomclick_js_warning: e
        })
      }

      throw e;
    }
  },
]);

tool.crashServer = async function (diff) {

  try {

    if ( typeof diff !== 'string' ) {

      throw th(`diff is not a string`);
    }

    if ( ! /^\d+$/.test(diff || '') ) {

      throw th(`atomclock.js diff (value: '${diff}') is not defined or it doesn't match /^\\d+$/`);
    }

    const crushnodeifdiffgreaterthansec = parseInt(diff, 10);

    const at = await tool(false);

    const now = parseInt((new Date()).getTime() / 1000, 10)

    const abs = Math.abs(at - now);

    if (abs > crushnodeifdiffgreaterthansec) {

      throw th(`atomclock.js time - node UTC time differance '${abs}' is greater than '${crushnodeifdiffgreaterthansec}' sec`);
    }

    console.log(`Time differance between atomclock.js time and node.js clock time is '${abs}', should be smaller than ${crushnodeifdiffgreaterthansec}`)

    console.log("Time diff is small enough üëç")
  }
  catch (e) {

    log.dump({
      atomclick_general_error: e
    })

    throw e;
  }
}

module.exports = tool;
                </script>
            </div>
            <div class="cards">
                <h2>Express template</h2>               
                <script type="editor" data-lang="js">

const path      = require('path');

const fs        = require('fs');

const express   = require('express');

const log       = (function(){try{return console.log}catch(e){return function (){}}}());

const template  = require('lodash/template');

// https://www.npmjs.com/package/cookie-parser
const cookieParser = require('cookie-parser'); 

// https://stackoverflow.com/a/23613092
const serveIndex    = require('serve-index');

const host      = process.env.HOST;

const port      = process.env.PORT;

const web = path.resolve(__dirname, 'public');

const readFile = file => fs.readFileSync(file).toString();

const app       = express();

app.use(cookieParser())

app.use(express.urlencoded({extended: false}));

app.use(express.json());

app.all('/save', (req, res) => {

    const cookies = decodeURIComponent(req.headers.cookie || '').split(';').reduce((acc, coo) => {
        const tmp   = coo.split('=');
        const name  = tmp.shift().trim();
        const value = tmp.join('=').trim();
        name && (acc[name] = value);
        return acc;
    }, {});

    log('save');
    log(JSON.stringify(req.body));

    res.setHeader('Content-type', 'application/json; charset=utf-8');
    res.end(JSON.stringify({
        ok: true
    }));
})

app.all('/root', (req, res) => {

    const html  = readFile(path.resolve(__dirname, 'public', '_index.html'));

    const svg   = readFile(path.resolve(__dirname, 'public', 'tree.svg'));

    const tmp = template(html);

    res.end(tmp({
        svg
    }));
});

app.use(express.static(web, { // http://expressjs.com/en/resources/middleware/serve-static.html
    // maxAge: 60 * 60 * 24 * 1000 // in milliseconds
    maxAge: '356 days', // in milliseconds max-age=30758400
    setHeaders: (res, path) => {

        if (/\.bmp$/i.test(path)) { // for some reason by default express.static sets here Content-Type: image/x-ms-bmp

            res.setHeader('Content-type', 'image/bmp')
        }

        // https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control
        // res.setHeader('Cache-Control', 'public, no-cache, max-age=30758400')
        // res.setHeader('Cache-Control', 'public, only-if-cached')
    }
}), serveIndex(web, {'icons': true}));

app.listen(port, host, () => {

    console.log(`\n üåé  Server is running ` + `${host}:${port}\n`)
});
                </script>             
                <script type="editor" data-lang="json">
{
  "dependencies": {
    "body-parser": "^1.18.3",
    "express": "^4.16.3",
    "lodash": "^4.17.10",
    "serve-index": "^1.9.1"
  }
}
                
                </script> 
            </div>

            <div class="cards">
                <h2>colors</h2>  
                <a href="https://www.npmjs.com/package/colors">NPM - colors</a>
                <table width="100%">
                    <tbody>
                        <tr>
                            <td>
                <script type="editor" data-lang="js">
require('colors');
const l = c => console.log(`${c} [` + (`test string`[c]) + ']');
console.log("\n\n");
// text colors
l('black');
l('red');
l('green');
l('yellow');
l('blue');
l('magenta');
l('cyan');
l('white');
l('gray');
l('grey');
// bg colors
l('bgBlack');
l('bgRed');
l('bgGreen');
l('bgYellow');
l('bgBlue');
l('bgMagenta');
l('bgCyan');
l('bgWhite');
//styles
l('reset');
l('bold');
l('dim');
l('italic');
l('underline');
l('inverse');
l('hidden');
l('strikethrough');
//extras
l('rainbow');
l('zebra');
l('america');
l('trap');
l('random');
console.log("\n\n")                
                </script> 
                            </td>
                            <td width="257">
                                <img src="/img/node/colors.png" height="624"/>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <script type="editor" data-lang="js">

// https://i.imgur.com/mWzuQWP.png
const color = (function (c) {
    return (...args) => c[args.pop()] + args.join('') + c.reset;
}({
    Bright      : "\x1b[1m",
    Dim         : "\x1b[2m",
    Underscore  : "\x1b[4m",
    Blink       : "\x1b[5m",
    Reverse     : "\x1b[7m",
    Hidden      : "\x1b[8m",
    FgBlack     : "\x1b[30m",
    FgRed       : "\x1b[31m", // red
    FgGreen     : "\x1b[32m", // green
    FgYellow    : "\x1b[33m", // yellow
    FgBlue      : "\x1b[34m",
    FgMagenta   : "\x1b[35m", // magenta
    FgCyan      : "\x1b[36m", // cyan
    FgWhite     : "\x1b[37m",
    BgBlack     : "\x1b[40m",
    BgRed       : "\x1b[41m",
    BgGreen     : "\x1b[42m",
    BgYellow    : "\x1b[43m",
    BgBlue      : "\x1b[44m",
    BgMagenta   : "\x1b[45m",
    BgCyan      : "\x1b[46m",
    BgWhite     : "\x1b[47m",
    r           : "\x1b[31m", // red
    g           : "\x1b[32m", // green
    y           : "\x1b[33m", // yellow
    m           : "\x1b[35m", // magenta
    c           : "\x1b[36m", // cyan
    reset       : "\x1b[0m",
}));

const c = (...args) => process.stdout.write(color(...args));

                </script>
            </div>

            <div class="cards">
                <h2>request.js</h2>  
                <script type="editor" data-lang="js">
                
# npm install inspc serialize-error    
# yarn add inspc serialize-error                
                
const URL           = require('url').URL;

const https         = require('https');

const http          = require('http');

const querystring   = require('querystring');

const se = require('nlab/se');

const th            = msg => new Error(`request: ${String(msg)}`);

const log           = require('inspc');

module.exports = function request(url, opt = {}) {

  let {
    method      = 'GET',
    timeout     = 30 * 1000,
    get         = {},
    verbose     = true,
  } = opt;

  if ( typeof method !== 'string' ) {

    throw th(`method is not a string`);
  }

  method = method.toUpperCase();

  return new Promise((resolve, reject) => {

    const uri   = new URL(url);

    const lib   = (uri.protocol === 'https:') ? https : http;

    const query = querystring.stringify(get)

    const rq = {
      hostname    : uri.hostname,
      port        : uri.port || ( (uri.protocol === 'https:') ? '443' : '80'),
      path        : uri.pathname + uri.search + (query ? (uri.search.includes('?') ? '&' : '?') + query : ''),
      method,
      headers     : {
        'Content-Type': 'application/json; charset=utf-8',
        Accept: `text/html; charset=utf-8`,
      },
    };

    if (verbose) {

      log.dump({
        'request.js': rq,
      }, 6);
    }

    var req = lib.request(rq, res => {
      res.setEncoding('utf8');

      let body = '';

      res.on('data', chunk => {

        body += chunk
      });

      res.on('end', () => {

        try {

          resolve({
            status: res.statusCode,
            headers: res.headers,
            body: JSON.parse(body),
          })
        }
        catch (e) {

          if (verbose) {

            log.dump({
              request_resolve_exception_catch: se(e),
            })
          }
          else {

            throw e;
          }
        }
      });
    });

    req.on('socket', function (socket) { // uncomment this to have timeout

      socket.setTimeout(timeout);

      socket.on('timeout', () => { // https://stackoverflow.com/a/9910413

        req.abort();

        reject({
          type: 'timeout',
        })
      });
    });

    req.on('error', e => reject({
      type: 'error',
      error: String(e),
    }));

    if ( typeof opt.json !== 'undefined' ) {

      if (opt.method === 'GET') {

        throw th(`opt.json is given but method is still GET`);
      }

      req.write(JSON.stringify(opt.json));
    }

    req.end();
  });
}

                </script> 
            </div>

            <div class="cards">
                <h2>jsonfetch.js</h2>  
                <script type="editor" data-lang="js">


const URL           = require('url').URL;

const https         = require('https');

const http          = require('http');

const querystring   = require('querystring');

const isObject      = require('nlab/isObject');

const log           = require('inspc');

const emsg          = msg => `jsonfetch: ${msg}`;

const th            = msg => new Error(emsg(msg));

module.exports = function jsonfetch (url, opt = {}) {

  let {
    method      = 'GET',
    timeout     = 30 * 1000,
    get         = {},
    headers     = {},
    debug       = false,
    body,
    nobody      = false,
  } = opt;

  if ( typeof method !== 'string' ) {

    throw th(`method is not a string`);
  }

  method = method.toLowerCase();

  return new Promise((resolve, reject) => {

    const uri   = new URL(url);

    const lib   = (uri.protocol === 'https:') ? https : http;

    const query = querystring.stringify(get)

    if (isObject(body) || Array.isArray(body)) {

      if (method === 'GET') {

        method = 'POST';
      }

      try {

        body = JSON.stringify(body);
      }
      catch (e) {

        return reject(emsg(`JSON.stringify error: ${e}`));
      }

      headers['Content-Type'] = 'application/json; charset=utf-8';
    }

    const rq = {
      hostname    : uri.hostname,
      port        : uri.port || ( (uri.protocol === 'https:') ? '443' : '80'),
      path        : uri.pathname + uri.search + (query ? (uri.search.includes('?') ? '&' : '?') + query : ''),
      method,
      headers,
    };

    if (debug) {

      log.dump({
        rq,
      }, 6);
    }

    var req = lib.request(rq, res => {

      res.setEncoding('utf8');

      let body = '';

      res.on('data', chunk => {

        body += chunk
      });

      res.on('end', () => {

        const isJson = (function () {

          try {

            return res.headers['content-type'].includes('application/json');
          }
          catch (e) {

            return false;
          }
        }());

        if (isJson) {

          try {

            body = JSON.parse(body);
          }
          catch (e) {

            reject(emsg(`JSON.parse(response body) error: ${e}`))
          }
        }

        const payload = {
          status: res.statusCode,
          headers: res.headers,
        };

        if (nobody === false) {

          payload.body = body;
        }

        resolve(payload)
      });
    });

    req.on('socket', function (socket) { // uncomment this to have timeout

      socket.setTimeout(timeout);

      socket.on('timeout', () => { // https://stackoverflow.com/a/9910413/5560682

        req.abort();

        reject(emsg(`timeout`))
      });
    });

    req.on('error', e => reject(emsg(`on error: ${e}`)));

    body && req.write(body);

    req.end();
  });
}




                </script> 
            </div>
            
            <div class="cards">
                <h2>nvm</h2>  
                <script type="editor" data-lang="sh">
                
nvm ls
nvm install [version]
nvm use [version]
.nvmrc
nvm alias default v8.15.1
nvm ls-remote

                </script> 
            </div>
            
            <div class="cards">
                <h2>base64</h2>  
                <script type="editor" data-lang="sh">
                
Buffer.from(json).toString('base64')
Buffer.from(base64, 'base64').toString('ascii');

                </script> 
            </div>
            
            <div class="cards">
                <h2>cmd promise</h2>  
                <script type="editor" data-lang="js">
                
const { spawn } = require("child_process");

const se = require('nlab/se');

const th    = msg => new Error(`${__filename} error: ${msg}`);

/**
 * Running:
 *
 const data = await cmd([
 'ls',
 '-la',
 '/Users/sd/Workspace/projects/monorepo/monorepo-master/a b c/test'
 ]);
 will work for directory with spacec in name
 */

module.exports = (cmd, opt) => new Promise((resolve, reject) => {

  if (typeof cmd === 'string') {

    cmd = cmd.trim();

    if ( ! cmd ) {

      throw th(`cmd is an empty string`);
    }

    cmd = commandb.split(/\s+/);
  }

  if ( ! Array.isArray(cmd) ) {

    throw th(`cmd is not an array`);
  }

  if ( ! cmd.length) {

    throw th(`cmd is an empty array`);
  }

  const {
    verbose = false,
  } = {...opt};

  verbose && console.log(`executing command ${c.g(cmd.join(' '))}`)

  const [command, ...args] = cmd;

  const process = spawn(command, args);

  let stdout = '';

  let stderr = '';

  process.stdout.on("data", data => {
    stdout += String(data);
  });

  process.stderr.on("data", data => {
    stderr += String(data);
  });

  process.on('error', (e) => {

    verbose && console.log(`error: ${e.message}`);

    reject({
      cmd,
      stdout,
      stderr,
      e: se(e)
    });
  });

  process.on("close", code => {

    verbose && console.log(`child process ${c.g(cmd.join(' '))} exited with code ${code}`);

    if (code !== 0) {

      return reject({
        cmd,
        stdout,
        stderr,
        code,
      });
    }

    resolve({
      cmd,
      stdout,
      stderr,
      code,
    });
  });
})                

                </script> 
            </div>
                        
        </div>
    </div>
</body>
</html>
