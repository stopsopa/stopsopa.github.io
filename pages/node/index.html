<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>stopsopa.github.io</title>
    <script>
      (function () {
        var resolve;
        var p = new Promise(function (res) {
          resolve = res;
        });

        document.addEventListener("DOMContentLoaded", () => {
          Array.prototype.slice.call(document.querySelectorAll('[class="domain.com"]')).forEach(function (tag) {
            var text = tag.innerHTML;

            text = text.replace(/domain\.com/g, location.origin);

            tag.innerHTML = text;
          });

          resolve();
        });

        window.beforeAceEventPromise = function () {
          return p;
        };
      })();
    </script>
  </head>
  <body class="layout" toc>
    <div class="body">
      <div class="inside">
        <div class="cards toc">
          <h1>Table of Contents</h1>
          <ul data-do-sort></ul>
        </div>

        <div class="cards">
          <h2>UMD (Universal Module Definition)</h2>
          <a href="https://github.com/umdjs/umd#tooling">https://github.com/umdjs/umd#tooling</a>
          <h2>Installation on linux</h2>
          <a href="https://github.com/nodesource/distributions#installation-instructions-1">Installation nodesource</a>
          <script type="editor" data-lang="js">


            (function (root, factory) {
              if (typeof define === "function" && define.amd) {

                // list of dependencies here to check vvv
                define(["jquery", "underscore"], factory);

              } else if (typeof exports === "object") {

                // list of dependencies here to check vvv
                module.exports = factory(require("jquery"), require("underscore"));

              } else {

                // global name of library to set
                var name = '__MY_LIBRARY_GLOBAL_NAME';

                var original = root[name];

                // list of dependencies here to check vvv
                var lib = factory(root.$, root._);

                root[name] = lib;

                root['__' + name + 'NoConflict'] = function () {

                  root[name] = original;

                  return lib;
                };
              }
              // list of dependencies here to check vvv
            })(this, function ($, _) {

              var tool = {}; // this object will be your library

              return tool;
            });
          </script>
        </div>
        <h2>About Node.js</h2>
        <a href="https://medium.datadriveninvestor.com/the-node-js-architecture-f86e2337bcd2">The Node.js Architecture!</a>
        <br />
        <a href="https://nodejs.dev/learn/understanding-setimmediate">https://nodejs.dev/learn/understanding-setimmediate</a>
        <br />
        <a href="https://github.com/nodejs/node/releases/tag/v18.0.0">v18 release</a>
        <br />
        <a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/">The Node.js Event Loop, Timers, and process.nextTick()</a>
        <h2>useful</h2>
        <script type="editor" data-lang="sh">

          npx envinfo

          NODE_OPTIONS="..." # https://nodejs.org/api/cli.html#node_optionsoptions
        </script>

        <h2>execute directly from cmd</h2>
        <script type="editor" data-lang="sh">

          cat <<EOF | node
          const json = require('./package.json')
          const data = Object.keys(Object.assign({}, json.dependencies, json.devDependencies))
            .filter((l) => l.includes('babel'))
            .map((l) => 'yarn add ' + l)
          console.log(data.join(require('os').EOL))
          EOF

          node -e "
          console.log('test1');
          console.log('test2');
          "
        </script>

        <h2>Semantic release</h2>
        <script type="editor" data-lang="sh">

          /bin/bash bash/swap-files-v2.sh package.json package.dev.json -- yarn add -D semantic-release conventional-changelog-conventionalcommits
            # from: https://github.com/semantic-release/semantic-release/issues/1652#issuecomment-714150790

          cat <<EEE > release.config.js
          module.exports = {
            preset: 'conventionalcommits',
          };
          EEE

            # from:  https://github.com/semantic-release/semantic-release/blob/master/docs/usage/configuration.md#configuration-file

          node node_modules/.bin/semantic-release

          # npx semantic-release - will not work if conventional used

          # ----------------------
          <type>(<scope>): <description|short summary>
            │       │             │
            │       │             └─⫸ Summary in present tense. Not capitalized. No period at the end.
            │       │
            │       └─⫸ Commit Scope: animations|bazel|benchpress|common|compiler|compiler-cli|core|
            │                          elements|forms|http|language-service|localize|platform-browser|
            │                          platform-browser-dynamic|platform-server|router|service-worker|
            │                          upgrade|zone.js|packaging|changelog|docs-infra|migrations|ngcc|ve|
            │                          devtools
            │
            └─⫸ Commit Type: build ci docs feat fix perf refactor test                    - angular
                              build ci docs feat fix perf refactor test chore revert style - conventional


          [optional body]

          [optional footer(s)]

          # --------------------

          # alternative Angular Commit Message Conventions.
          https://github.com/angular/angular/blob/main/CONTRIBUTING.md#-commit-message-format
            # there is even more: https://github.com/conventional-changelog/commitlint/#shared-configuration

             mentioned in: https://github.com/semantic-release/semantic-release#commit-message-format
        </script>
        <br />
        <a href="https://i.imgur.com/LLOtsyy.png" target="_blank"><img src="https://i.imgur.com/LLOtsyy.png" style="width: 1000px" /></a>

        <br />
        <a href="https://gist.github.com/joshbuchea/6f47e86d2510bce28f8e7f42ae84c716">https://gist.github.com/joshbuchea/6f47e86d2510bce28f8e7f42ae84c716</a>
        <br />
        <a href="https://github.com/semantic-release/semantic-release#commit-message-format">More about "BREAKING CHANGE:"</a>
        <br />
        <a href="https://github.com/semantic-release/semantic-release">https://github.com/semantic-release/semantic-release</a>
        <br />
        <a href="https://gist.github.com/joshbuchea/6f47e86d2510bce28f8e7f42ae84c716">https://gist.github.com/joshbuchea/6f47e86d2510bce28f8e7f42ae84c716</a>
        <br />
        <a href="https://www.conventionalcommits.org/en/v1.0.0/">https://www.conventionalcommits.org/en/v1.0.0/</a>
        <br />
        <a href="https://conventionalcomments.org/">https://conventionalcomments.org/</a>
        <br />

        <h2>husky</h2>
        <h2>commitlint</h2>
        <script type="editor" data-lang="sh">

          yarn add -D husky

          cat .git/config
          ls -la .husky
          npm set-script prepare "husky install"
          npx husky install
          cat .git/config
          ls -la .husky

          yarn add @commitlint/cli @commitlint/config-conventional husky -D
          echo 'module.exports = { extends: ["@commitlint/config-conventional"] };' > commitlint.config.js

            # from: https://github.com/conventional-changelog/commitlint/#getting-started


          yarn husky add .husky/commit-msg 'npx --no -- commitlint --edit "$1"'

          # or

          cat <<EEE > .husky/commit-msg
            #!/bin/sh
            . "\$(dirname "\$0")/_/husky.sh"

            npx --no -- commitlint --edit "\${1}"
          EEE

            # from: https://github.com/conventional-changelog/commitlint/#getting-started
        </script>
        <h2>prettier setup</h2>
        <script type="editor" data-lang="sh">

          yarn add -D prettier

          // ESM
          # Requires NPM >=v7
          npm set-script "style:check" "yarn prettier --config prettier.config.mjs --check ."
          npm set-script "style:fix" "yarn prettier --config prettier.config.mjs --write ."
          npm set-script "style:list" "yarn prettier --config prettier.config.mjs --list-different ."

          # or just add manually to package.json for older version of NPM:
          "style:check": "yarn prettier --config prettier.config.mjs --check .",
          "style:fix": "yarn prettier --config prettier.config.mjs --write .",
          "style:list": "yarn prettier --config prettier.config.mjs --list-different ."

          cat <<EEE > prettier.config.mjs
          export default {
            printWidth: 120,
            // semi: false,
          };
          EEE

          // COMMON JS
          # Requires NPM >=v7
          npm set-script "style:check" "yarn prettier --config prettier.config.cjs --check ."
          npm set-script "style:fix" "yarn prettier --config prettier.config.cjs --write ."
          npm set-script "style:list" "yarn prettier --config prettier.config.cjs --list-different ."

          # or just add manually to package.json for older version of NPM:
          "style:check": "yarn prettier --config prettier.config.cjs --check .",
          "style:fix": "yarn prettier --config prettier.config.cjs --write .",
          "style:list": "yarn prettier --config prettier.config.cjs --list-different ."

          cat <<EEE > prettier.config.cjs
          module.exports = {
            printWidth: 120,
            // semi: false,
          };
          EEE

          // optionally add   // semi: false,

            # declaring it as .mjs file is important because of this issue: https://stackoverflow.com/questions/71184604/prettier-fails-when-declaring-type-module-in-package-json


          cat <<EEE > .prettierignore
          /.ci
          /lib
          /coverage
          /.nyc_output
          /flow-typed
          /package.json
          /var/
          EEE

          # by default .prettierignore seems to include all .gitignore files from project
          # (search for DEFAULT_IGNORE in github repository and follow it's logic)


          npx prettier --write src
              # https://prettier.io/docs/en/cli.html#docsNav
        </script>

        <div class="cards">
          <h2>Extract engines script</h2>
          <script type="editor" data-lang="sh" class="domain.com">

            wget --help 1> /dev/null 2> /dev/null
            if [ "$?" = "0" ]; then
              wget --no-cache -O "vault.sh" "domain.com/pages/node/engines.js"
            else # curl
              curl "domain.com/pages/node/engines.js" -o "vault.sh"
            fi

            /bin/bash vault.sh jest
          </script>
          <h2>hash pbkdf2</h2>
          <script type="editor" data-lang="sh" class="domain.com">

            const { promisify } = require("util");

            const { performance } = require("node:perf_hooks");

            const crypto = require("crypto");

            const log = console.log;

            async function pbkdf2(password, salt, cost = 200000, digest = "sha512") {

              const derivedKey = await promisify(crypto.pbkdf2)(password, salt, cost, 32, digest);

              return derivedKey.toString("hex");
            }

            async function time(password, salt, cost = 200000, digest = "sha512") {
              const start = performance.now();

              const hash = await pbkdf2(password, salt, cost, digest)

              const end = performance.now();

              log(password, cost, hash, digest, start, end);
            }

            const salt = crypto.randomBytes(32);

            const password = "abcdef";

            time(password, salt);
            time(password, salt);
          </script>
          <a href="https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html">Check compliance</a>

          <h2>Best practices</h2>

          <a href="https://github.com/goldbergyoni/nodebestpractices">https://github.com/goldbergyoni/nodebestpractices</a>
          <br />
          <h2>yarn</h2>
          <script type="editor" data-lang="sh">

            yarn set version berry
            yarn set version 1.22.10
                # https://github.com/yarnpkg/yarn/releases

            yarn outdated
            yarn upgrade-interactive
            yarn upgrade-interactive --latest

            yarn install --production=true  # no devDependencies
            yarn install --production=false # with devDependencies
                # from: https://classic.yarnpkg.com/en/docs/cli/install/#toc-yarn-install-production-true-false

            yarn why library
                # to see why library is in deps

            yarn cache clean --force
                # Remove the shared cache files. https://yarnpkg.com/cli/cache/clean

            yarn audit
          </script>
          <h2>dotenv</h2>
          <script type="editor" data-lang="js">

            const fs = require('fs');

            const path = require('path');

            const env = path.resolve(path.dirname(__dirname), '.env');

            if ( ! fs.existsSync(env) ) {

              throw new Error(`File ${env} doesn't exist`);
            }

            require('dotenv').config({
              path: env,
            });

            console.log('env', process.env);


            # index.mjs (ESM)

            import fs from "fs";

            import path from "path";

            import { fileURLToPath } from "url";
            const __filename = fileURLToPath(import.meta.url);
            const __dirname = path.dirname(__filename);

            const env = path.resolve(__dirname, "..", ".env");

            if (!fs.existsSync(env)) {
              throw new Error(`File ${env} doesn't exist`);
            }

            import * as dotenv from "dotenv"; // see https://github.com/motdotla/dotenv#how-do-i-use-dotenv-with-import

            dotenv.config({
              path: env,
            });
          </script>
        </div>
        <div class="cards">
          <h2>htmlencode htmldecode</h2>
          <script type="editor" data-lang="js">

            // based on lodash implementation
            const log = console.log;

            var escape = (function () {
              var htmlEscapes = {
                "&": "&amp;amp;",
                "<": "&amp;lt;",
                ">": "&amp;gt;",
                '"': "&amp;quot;",
                "'": "&amp;#39;",
              };

              var escapeHtmlChar = (key) => htmlEscapes[key];

              var reUnescapedHtml = /[&<>"']/g,
                reHasUnescapedHtml = RegExp(reUnescapedHtml.source);

              return function (string) {
                string = String(string);
                return string && reHasUnescapedHtml.test(string) ? string.replace(reUnescapedHtml, escapeHtmlChar) : string;
              };
            })();

            var unescape = (function () {
              var htmlUnescapes = {
                "&amp;amp;": "&",
                "&amp;lt;": "<",
                "&amp;gt;": ">",
                "&amp;quot;": '"',
                "&amp;#39;": "'",
              };

              var unescapeHtmlChar = (key) => htmlUnescapes[key];

              var reEscapedHtml = /&(?:amp|lt|gt|quot|#39);/g,
                reHasEscapedHtml = RegExp(reEscapedHtml.source);

              return function (string) {
                string = String(string);
                return string && reHasEscapedHtml.test(string) ? string.replace(reEscapedHtml, unescapeHtmlChar) : string;
              };
            })();

            const str = ` abc & & < mid > < x " yy ' d '`;

            const enc = escape(str);

            const tmp = {
              str,
              dec: unescape(enc),
              enc,
            };

            tmp.eq = tmp.str === tmp.dec;

            log(tmp);
          </script>
          <h2>nodemon & chokidar</h2>
          <script type="editor" data-lang="sh">

            nodemon -e js,html server.js
            nodemon -x "node --experimental-specifier-resolution=node" -e js,html server.js
          </script>
          If it's not about running again server but command everytime file changes then use chokidar, like:
          <script type="editor" data-lang="sh">
            node node_modules/.bin/chokidar 'tests/**/*.spec.js' --initial -c 'npx playwright test --headed --forbid-only --project=chromium --workers=1 --retries=0 tests/001request.spec.js'
          </script>
          more: <a href="https://github.com/open-cli-tools/chokidar-cli">https://github.com/open-cli-tools/chokidar-cli</a> <br />
          <a href="https://github.com/microsoft/playwright/issues/7035">https://github.com/microsoft/playwright/issues/7035</a>
          <br />
          <a href="https://stackoverflow.com/a/13807906">about fswatch</a>
          <h2>streams</h2>
          <script type="editor" data-lang="js">

            // https://github.com/substack/stream-handbook
            // from: https://github.com/nkzawa/socket.io-stream

            // https://nodesource.com/blog/understanding-streams-in-nodejs/


            // https://www.freecodecamp.org/news/node-js-streams-everything-you-need-to-know-c9141306be93/
            // Create big file using stream
            const fs = require('fs');
            const file = fs.createWriteStream('./big.file');

            for(let i=0; i<= 1e6; i++) {
              file.write('Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.\n');
            }

            file.end();



            # https://www.freecodecamp.org/news/node-js-streams-everything-you-need-to-know-c9141306be93/
            # more: https://jscomplete.com/learn/node-beyond-basics/node-streams  g(node beyond basics)

            # https://www.sitepoint.com/basics-node-js-streams/
            # http://2ality.com/2018/04/async-iter-nodejs.html
            # http://2ality.com/2018/05/child-process-streams.html

            # read file to http response:
            const stream = fs.createReadStream(file);
            stream.pipe(res);

            # write http response to file:
            const stream = fs.createWriteStream(file);
            res.pipe(stream);

            readableStream.pipe(writableStream);

            # pipe stream error handling
            await new Promise((resolve, reject ) => {

              var stream = res.pipe(fs.createWriteStream(file));

              stream.on('finish', () => resolve());

              stream.on('error', e => reject({
                writable_stream_error: e
              }));
            });

            # unzip
            var fs = require('fs');
            var zlib = require('zlib');

            fs.createReadStream('input.txt.gz')
              .pipe(zlib.createGunzip())
              .pipe(fs.createWriteStream('output.txt'));
          </script>
          <h2>Signleton (kinda) module template</h2>
          <script type="editor" data-lang="js">

            const CachePromise = require('./CachePromise');

            const instances = {};

            const name = 'CachePromiseModule';

            const th = msg => new Error(`${name}.js error: ${msg}`);

            module.exports = (name = 'default', opt) => {

              if ( typeof name !== 'string' ) {

                throw th(`name is not a string`);
              }

              if ( instances[name] ) {

                return instances[name];
              }

              if ( ! isObject(opt) ) {

                throw th(`opt is not an object. Usually it means you are trying to get the instance before initialising it. Use first ${name}(name, opt) then ${name}(name)`);
              }

              return instances[name] = new CachePromise(opt);
            }

            function isObject(o) {
              return Object.prototype.toString.call(o) === '[object Object]';
            }
          </script>
          <h2>path</h2>
          <script type="editor" data-lang="js">
            # in php :
            $path_parts = pathinfo('/www/htdocs/inc/lib.inc.php');

            echo $path_parts['basename'], "\n"; // lib.inc.php
                // path.basename(test)
            echo $path_parts['extension'], "\n"; // php
                // path.extname(test).substring(1)
            echo $path_parts['dirname'], "\n"; // /www/htdocs/inc
                // path.dirname(test)
            echo $path_parts['filename'], "\n"; // since PHP 5.2.0 // lib.inc
                // path.basename(test, path.extname(test))
          </script>
          <h2>fs</h2>
          <script type="editor" data-lang="js">

            var fs          = require('fs');

            if (fs.existsSync(dirfile)) { // warning: if under dirfile there will be broken link (pointing to something nonexisting) then this function will return false even if link DO EXIST but it's broken



            }
            // file exist


            function pathExist(target) { // this function detects even broken symlink

              try {

                if ( fs.existsSync(target) ) {

                  return true;
                }

                const sym = fs.readlinkSync(target);

                if ( typeof sym === 'string' ) {

                  return true;
                }
              }
              catch (e) {

                // throw new Error('one' + `-- ${e}`);
              }

              return false;
            }

            // read sync
            const content = fs.readFileSync(file, options).toString();
            const content = fs.readFileSync(file, 'utf8').toString();

            fs.lstatSync(path_string).isDirectory()  // https://stackoverflow.com/a/15630832
            fs.lstatSync(path_string).isFile()
            fs.lstatSync(path_string).isBlockDevice()
            fs.lstatSync(path_string).isCharacterDevice()
            fs.lstatSync(path_string).isSymbolicLink() // (only valid with fs.lstat())
            fs.lstatSync(path_string).isFIFO()
            fs.lstatSync(path_string).isSocket()


            // write sync
            fs.writeFileSync(file.source, content);
            fs.appendFileSync(file.source, content);


            // delete remove file

            fs.unlinkSync(file);



            // https://nodejs.org/api/fs.html#fs_fs_access_path_mode_callback


                if ( ! fs.existsSync(file)) {

                    throw `file '${file}' doesn't exist`;
                }

                try {
                    fs.accessSync(file, fs.constants.R_OK);
                }
                catch (e) {

                    throw `file '${file}' is not readdable`;
                }

                try {
                    fs.accessSync(file, fs.constants.W_OK);
                }
                catch (e) {

                    throw `file '${file}' is not writtable`;
                }
                // handle like this becaue without try catch it's ugly, not telling explicitely if file is not readdalbe or not writtable

                // WARNING: Synchronous version of fs.access(). This throws if any accessibility checks fail, and does nothing otherwise.




                const path                  = require('path');

                const fs                    = require('fs');

                const listFilesSync = (dir, l = 0) => {

                    let pa, s;

                    let list = [];

                    fs.readdirSync(dir).forEach(p => {

                        pa  = path.resolve(dir, p);

                        s   = fs.lstatSync(pa);

                        // console.log('file: ', s.isFile() ? 'F' : 'D', ': ', ' '.repeat(l),  p);

                        // is_file is file
                        if (s.isFile()) {

                            list.push(['f', pa]);
                        }

                        if (s.isDirectory()) {

                            list.push(['d', pa]);

                            list = list.concat(listFilesSync(pa, l + 4));
                        }
                    })

                    return list;
                }
                ==== walk iterate through directories files recursively recursive ====== ^^^



                ==== find files list recursively ===== vvv

                const fs            = require('fs');

                var walkSync = function(dir, filelist) { // https://gist.github.com/kethinov/6658166#gistcomment-1603591

                    var p, files = fs.readdirSync(dir);

                    filelist = filelist || [];

                    files.forEach(function(file) {

                        p = path.resolve(dir, file);

                        if (fs.statSync(p).isDirectory()) { // is directory is_dir isdirectory

                            filelist = walkSync(p, filelist);
                        }
                        else {

                            filelist.push(p);
                        }
                    });

                    return filelist;
                };
          </script>
          <h2>Modules: ECMAScript modules</h2>
          <a href="https://nodejs.org/api/esm.html#enabling">Enabling ECMAScript module loader for project/library</a>
          <br />
          <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import">MDN import</a>
          <br />
          <a href="https://nodejs.org/api/packages.html#modules-loaders">Modules: Packages -&gt; Modules loaders (ECMAScript module loader & CommonJS module loader)</a>
          <script type="editor" data-lang="sh">

            "type": "module",

            node --experimental-specifier-resolution=node scripts.mjs


            import path from 'path';

            import {fileURLToPath} from 'url';

            const __filename = fileURLToPath(import.meta.url);

            const __dirname = path.dirname(__filename);



            import bootstrapVaultModule from "lib/from/node_modules/with/export/default";

            const bootstrapVault = bootstrapVaultModule.default;

            # To treat it as a CommonJS script, rename it to use the '.cjs' file extension.
            # (probably because the origin is strict EcmaScript Module, e. g. a module with javascript mimetype,
            # a '*.mjs' file, or a '*.js' file where the package.json contains '"type": "module"').

            # VSCode fix regexp:
            (?:var|const) ([^\s]+) = require\(['"]([^\)]+)['"]\)
            import $1 from "$2"

            # ECMAScript module loader facts
            *
            Within a package, the package.json "type" field defines how Node.js should interpret .js files.
            If a package.json file does not have a "type" field, .js files are treated as CommonJS.
            A package.json "type" value of "module" tells Node.js to
            interpret .js files within that package as using ES module syntax.
            The "type" field applies not only to initial entry points (node my-app.js) but also to
            files referenced by import statements and import() expressions.
                ...also...
            Files ending with .mjs are always loaded as ES modules regardless of the nearest parent package.json.
            Files ending with .cjs are always loaded as CommonJS regardless of the nearest parent package.json.
                # from: https://nodejs.org/api/packages.html#packagejson-and-file-extensions

            *
            ECMAScript module loader https://nodejs.org/api/packages.html#modules-loaders:
            - It does not support folders as modules, directory indexes (e.g. './startup/index.js') must be fully specified.
                it can be though skipped if >node  --experimental-specifier-resolution=node [your_script.js]< provided
                # from: https://nodejs.dev/en/api/v18/esm/#customizing-esm-specifier-resolution-algorithm
                # alternative: https://github.com/nodejs/loaders-test/tree/main/commonjs-extension-resolution-loader
                # WARNING:
                  # (node:94253) ExperimentalWarning: The Node.js specifier resolution flag is experimental.
                  # It could change or be removed at any time.

            *
            About Create React App:
            Because we have introduced "type": "module" in package.json
            Create React App will switch to ECMAScript module loader, therefore use
            import { fetchJson } from "./lib/transport.js";
            instead of
            import { fetchJson } from "./lib/transport";
                providing --experimental-specifier-resolution=node
                node --experimental-specifier-resolution=node node_modules/.bin/react-scripts start
                will not help

            *
            The CommonJS module require always treats the files it references as CommonJS.
            Using require to load an ES module is not supported because ES modules have asynchronous execution.
            Instead, use import() to load an ES module from a CommonJS module.
                # from: https://nodejs.dev/en/api/v18/esm/#require

            *
            Difference between 'import' and 'require'
            https://nodejs.org/api/esm.html#interoperability-with-commonjs
          </script>
          <p>asm.sh</p>
          <script type="editor" data-lang="sh">


            #
            # This script is to cover case when you have to use in node script two libraries
            # "dotenv" to load environment variables from .env and then
            # "config" which relays on those to properly read config
            # together
            # The occurs when you use ESM module system in node by executing .mjs file
            # or by turning on "type": "module", flag in package.json (more: https://nodejs.org/api/esm.html#enabling)
            # from that point even when you try to load both:
            #
            # import * as dotenv from "dotenv";
            #
            # dotenv.config({
            #   path: env,
            # });
            #
            # import config from "config";
            #
            # config will be executed first anyway
            # therefor one of solutions might be to load .env environment vars first and then executing
            # desired script
            #
            # then now you can just run:
            # /bin/bash esm.sh your_script.mjs
            #

            # keep in mind that this path will be resolved from CWD - Current working directory
            ENV=".env"

            if [ ! -f "${ENV}" ]; then

              echo "${0} error: '${NEV}' file doesn't exist"

              exit 1
            fi

            # will import env vars from file
            source "${ENV}"

            # will export all
            export $(cut -d= -f1 "${ENV}" | grep -v -E "^#" | tr "\n" " ")

            function quote {
              echo "$1" | sed -E 's/\"/\\"/g'
            }

            # preparing arguments passed to this script for evaluation
            _EVAL=""
            while (( "$#" )); do
                if [ "$1" = "&&" ]; then
                    _EVAL="$_EVAL &&"
                else
                  if [ "$_EVAL" = "" ]; then
                      _EVAL="\"$(quote "$1")\""
                  else
                      _EVAL="$_EVAL \"$(quote "$1")\""
                  fi
                fi
                shift;
            done

            set -e


            eval "node --experimental-specifier-resolution=node $_EVAL"
          </script>
          <h2>node.js testing (native)</h2>
          <a href="https://github.com/nodejs/node/blob/main/doc/changelogs/CHANGELOG_V19.md#2022-11-14-version-1910-current-rafaelgss"
            >https://github.com/nodejs/node/blob/main/doc/changelogs/CHANGELOG_V19.md#2022-11-14-version-1910-current-rafaelgss</a
          >
          <h2>fs/promises</h2>
          <script type="editor" data-lang="js">

            const fsPromises = require("node:fs/promises");

            // based on: https://github.com/nodejs/node/issues/39960#issuecomment-909444667
            // more about fs/promises: https://nodejs.org/api/fs.html#fspromisesstatpath-options
            // also some good advice: https://gist.github.com/joepie91/bbf495e044da043de2ba
            async function notExist(file) {
              try {
                await fsPromises.stat(file);
                return false;
              } catch (e) {
                return e;
              }
            };

            (async () => {
              try {
                {
                  const nExist = await notExist(templateFile);

                  if (nExist) {
                    throw th(`template file '${templateFile}' doesn't exist (${nExist.message})`);
                  }
                }

                let template;

                {
                  const result = await fsPromises.readFile(templateFile, "utf8");

                  template = result.toString();
                }

              } catch (e) {
                log(`

            Global catch:

                `);

                throw e;
              }
            })();
          </script>
          <h2>eslint</h2>
          <script type="editor" data-lang="python">

            # raw config
            https://github.com/standard/eslint-config-standard/blob/master/eslintrc.json
            https://eslint.org/docs/rules/

            # error levels:
            https://eslint.org/docs/user-guide/getting-started#configuration

            https://eslint.org/docs/1.0.0/rules/padded-blocks
          </script>
          <h2>npm</h2>
          <script type="editor" data-lang="sh">

            npm install --production       # no devDependencies
            npm install --production=false # with devDependencies
                # from: https://docs.npmjs.com/cli/v7/commands/npm-install

            $(npm bin)/cypress open
                # from: https://docs.cypress.io/guides/getting-started/installing-cypress.html#Opening-Cypress

            npm root -g
                # npm global node_module

            npm init
            npm init --scope=stopsopa
                {
                  "name"    : "@stopsopa/line",
                  "version"    : "2.0.0",
                  "description"    : "Lib to draw lines using one div and css",
                  "main"    : "line.js",
                  "scripts": {
                    "test"    : "echo \"Error: no test specified\" && exit 1",
                    "start"    : "node server.js"
                  },
                  "repository": {
                    "type"    : "git",
                    "url"    : "git@github.com:stopsopa/line.git"
                  },
                  "author"    : "Szymon Dzialowski",
                  "license"    : "MIT",
                  "homepage"    : "https://github.com/stopsopa/line"
                }
            npm login
            npm config ls
            .npmignore
                # testing .npmignore run "npm pack" - https://docs.npmjs.com/misc/developers#testing-whether-your-npmignore-or-files-config-works

            npx: https://docs.npmjs.com/files/package.json#bin

            npm version patch
            npm publish --access=public

            https://badge.fury.io/for/js/bash-make-lifecycle - badge generator

            npm link    # https://www.youtube.com/watch?v=nKFe1lhGSk0 usefull if you are in the process of development of something
                # known issues: https://github.com/npm/npm/issues/20954#issuecomment-397114152

            # pre scripts
            # https://www.google.com/search?q=npm+Pre+and+Post+Scripts
            # https://docs.npmjs.com/cli/v8/using-npm/scripts

            npm cache clean --force
                # Remove the shared cache files. https://docs.npmjs.com/cli/v7/commands/npm-cache

            resolution:

            package.json:
            {
              "resolutions": {
                "**/elastic-apm-node": "3.39.0"
              },
            }
          </script>
        </div>

        <div class="cards">
          <h2>Dependencies - analysing</h2>
          <a href="https://npmgraph.js.org/?q=nlab">https://npmgraph.js.org/?q=nlab</a>
          <h2>Type annotations syntax</h2>
          <a href="https://github.com/tc39/proposal-type-annotations">https://github.com/tc39/proposal-type-annotations</a>
          <h2>Native test runner - native tests</h2>
          <a href="https://nodejs.org/download/nightly/v18.0.0-nightly20220403561885152e/docs/api/test.html"
            >https://nodejs.org/download/nightly/v18.0.0-nightly20220403561885152e/docs/api/test.html</a
          >
          <h2>CORS</h2>
          <a href="https://livebook.manning.com/book/cors-in-action/chapter-5/">Read more about CORS</a>
          <script type="editor" data-lang="sh">

            // CORS
            (function () {

              const th = msg => new Error(`Cors configuration error: ${msg}`)

              const trim = require('nlab/trim');

              const negotiatePort = require('nlab/negotiatePort');

              function isObject(o) {
                return Object.prototype.toString.call(o) === '[object Object]';
              }

              if ( ! process.env.PROTECTED_CORS_ALLOWED_DOMAINS ) {

                throw th(`process.env.PROTECTED_CORS_ALLOWED_DOMAINS is not defined`);
              }

              const whitelist = process.env.PROTECTED_CORS_ALLOWED_DOMAINS
                .split(' ')
                .map(t => trim(t))
                .filter(Boolean)
                .map(t => {

                  try {

                    t = new URL(t);

                    return t.protocol + "//" + t.hostname + negotiatePort(t.protocol, t.port, ':');
                  }
                  catch (e) {

                    throw th(`process.env.PROTECTED_CORS_ALLOWED_DOMAINS processing part '${t}' failed: ${e}`);
                  }
                })
              ;

              console.log(JSON.stringify({
                PROTECTED_CORS_ALLOWED_DOMAINS: whitelist,
              }, null, 4))

              if ( ! whitelist.length ) {

                throw th(`process.env.PROTECTED_CORS_ALLOWED_DOMAINS after processing is an empty list`);
              }

              var cors = require('cors');

              app.use((req, res, next) => {

                if (isObject(req.headers) && typeof req.headers.origin === 'string' && trim(req.headers.origin)) {

                  console.log(`request: ${req.method} ${req.url} - handle cors true ${req.headers.origin}`)

                  return cors({
                    exposedHeaders: 'X-session',
                    origin: function (origin, callback) {
                      if (whitelist.includes(origin)) {
                        callback(null, true)
                      } else {
                        callback(new Error(`${origin} Not allowed by CORS`))
                      }
                    }
                  })(req, res, next);
                }

                console.log(`request: ${req.method} ${req.url} - handle cors next`)

                next();
              })
            }());
          </script>
        </div>
        <div class="cards">
          <h2>processing url uri</h2>
          <script type="editor" data-lang="js">


            const originalUrl = require('original-url'); // yarn add original-url

            const original = originalUrl(req);

            const requestIp = require('request-ip');

            app.use(requestIp.mw()); // get ip                  req.clientIp

            log.dump({
                original,
                headers             : req.headers,
                originalUrl         : req.originalUrl, // https://expressjs.com/en/api.html#req.originalUrl
                url                 : req.url,
                method              : req.method,
                host                : req.get('host'),
                origin              : req.get('origin'),
                protocol            : req.protocol,
                secure              : req.secure,  //  WARNING: USE IN FUTURE LIBRARY original-url FROM NPM IF PAGE IS BEHIND PROXY PASS WITH HEADER x-forwarded-ssl OR x-forwarded-proto
                reconstrucred       : req.protocol + '://' + req.get('host') + req.url, //  WARNING: USE IN FUTURE LIBRARY original-url FROM NPM IF PAGE IS BEHIND PROXY PASS WITH HEADER x-forwarded-ssl OR x-forwarded-proto
            })
            Object {// for https://amlstage.phaseiilabs.com:8080/tester/tester?raz=dwa behind nginx proxy
                "original": {
                    "raw"    : "/tester/tester?raz=dwa",
                    "protocol"    : "http:", // WARNING: will be "https:" if X-Forwarded-Proto $scheme; OR(I'VE TESTED THIS 'OR' IN BOTH CASES WILL WORK, COMMEND ONE OR ANOTHER) X-Forwarded-SSL   on; added
                    "hostname"    : "212.67.96.161", // WARNING: becareful it might return ip address WARNING WARNING
                    "port": 8080, // key exist only if [proxy_set_header X-Forwarded-Port $server_port;] added to nginx
                    "pathname"    : "/tester/tester",
                    "search"    : "?raz=dwa",
                    "full"    : "http://212.67.96.161:8080/tester/tester?raz=dwa"
                },
                "headers": {
                    "connection"    : "upgrade",
                    "host"    : "amlstage.phaseiilabs.com",
                    "x-real-ip"    : "212.67.96.161",
                    "x-forwarded-for"    : "212.67.96.161",
                    "x-forwarded-host"    : "212.67.96.161",
                        "x-forwarded-port"    : "8080",     // will appear only if [proxy_set_header X-Forwarded-Port $server_port;] added to nginx config
                        "x-forwarded-proto"    : "https",   // will appear only if [proxy_set_header X-Forwarded-Proto $scheme;] added to nginx config
                        "x-forwarded-ssl"    : "on",        // will appear only if [proxy_set_header X-Forwarded-SSL on;] added to nginx config
                    "cache-control"    : "max-age=0",
                    "upgrade-insecure-requests"    : "1",
                    "user-agent"    : "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.122 Safari/537.36",
                    "sec-fetch-dest"    : "document",
                    "accept"    : "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
                    "sec-fetch-site"    : "none",
                    "sec-fetch-mode"    : "navigate",
                    "sec-fetch-user"    : "?1",
                    "accept-encoding"    : "gzip, deflate, br",
                    "accept-language"    : "en-GB,en-US;q=0.9,en;q=0.8,pl;q=0.7,it;q=0.6,fr;q=0.5,es;q=0.4,de;q=0.3,ru;q=0.2,mt;q=0.1,pt;q=0.1,id;q=0.1",
                    "cookie"    : "_ga=GA1.2.477192506.1582642627; _hjid=38ba37f0-33bc-48ad-bf45-a82f453729f2; _gid=GA1.2.250183521.1583161185; jwt_cookie=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwicm9sZXMiOlsiYWRtaW4iLCJ1c2VyIl0sImlhdCI6MTU4MzI0NTc5MCwiZXhwIjoxNTgzMjc4MTkwfQ.IYyoBu4QQ0lEKk3G4XjIczha68XezAZs8ds4RbEak80",
                    "if-none-match"    : "W/\"19f-eK38WW4dYefk0hfT3dbOw33zsbo\""
                },
                "originalUrl"    : "/tester/tester?raz=dwa",
                "url"    : "/tester/tester?raz=dwa",
                "method"    : "GET",
                "host"    : "amlstage.phaseiilabs.com",
                "protocol"    : "http",
                "secure": false, // adding X-Forwarded-Proto $scheme; or X-Forwarded-SSL   on; will not help here, use "original-url" to resolve headers and then use original.protocol (it will be equal "https:")
                "reconstrucred"    : "http://amlstage.phaseiilabs.com/tester/tester?raz=dwa"
            }

            --- express headers ----- vvv
            log.dump({
                originalUrl         : req.originalUrl, // https://expressjs.com/en/api.html#req.originalUrl
                url                 : req.url,
                method              : req.method,
                host                : req.get('host'),
                origin              : req.get('origin'),
                protocol            : req.protocol,
                secure              : req.secure,  //  WARNING: USE IN FUTURE LIBRARY original-url FROM NPM IF PAGE IS BEHIND PROXY PASS WITH HEADER x-forwarded-ssl OR x-forwarded-proto
                'original.protocol' : original.protocol,
                reconstrucred       : req.protocol + '://' + req.get('host') + req.url, //  WARNING: USE IN FUTURE LIBRARY original-url FROM NPM IF PAGE IS BEHIND PROXY PASS WITH HEADER x-forwarded-ssl OR x-forwarded-proto
            }, 4)
            Object {
              <originalUrl> [String]: >/sockjs-node/info?t=1582335313746< len: 33
              <url> [String]: >/sockjs-node/info?t=1582335313746< len: 33
              <method> [String]: >GET< len: 3
              <host> [String]: >localhost:1025< len: 14
              <origin> [Undefined]: >undefined<
              <protocol> [String]: >http< len: 4
              <secure> [Boolean]: >false<
              <original.protocol> [String]: >https<
              <reconstrucred> [String]: >http://localhost:1025/sockjs-node/info?t=1582335313746< len: 54
            }

            --- express headers ----- ^^^

            const URL           = require('url').URL;

            const log           = require('inspc');

            const target = `https://usertes:pasword@sub.domain.com:1025/curl?one=two&three=rour&q=89.67.167.34&dwa=trzy&one=three#hash_bang`;

            const uri   = new URL(target);

            log.dump({ // https://nodejs.org/docs/latest-v7.x/api/url.html#url_url_parse_urlstring_parsequerystring_slashesdenotehost
                hash____    : uri.hash,
                host____    : uri.host,
                hostname    : uri.hostname,
                href____    : uri.href,
                origin__    : uri.origin,
                password    : uri.password,
                pathname    : uri.pathname,
                port____    : uri.port,
                protocol    : uri.protocol,
                search__    : uri.search,
                searchParams: uri.searchParams, // https://nodejs.org/docs/latest-v7.x/api/url.html#url_class_urlsearchparams
                username    : uri.username,,
                target,
                path: uri.pathname + uri.search + uri.hash

                https___    : uri.protocol.indexOf('https') > -1,
                searchParams_all: Array.from(uri.searchParams.keys()).reduce((acc, key) => {
                    acc[key] = uri.searchParams.getAll(key)
                    return acc;
                }, {}), // https://nodejs.org/docs/latest-v7.x/api/url.html#url_class_urlsearchparams

                'using with http.request():'         : {
                    hostname    : uri.hostname,
                    port        : uri.port,
                    path        : uri.pathname,
                    method      : 'POST',
                    headers     : {
                        'Content-Type': 'application/json'
                    },
                    // timeout: 2000,
                },
                'url.parse': require('url').parse(target)
            }, 5)

            // 2019-04-26 10:23:42 /Users/sd/Workspace/projects/z_roderic_new/roderic-project/url.js:11
            // Object {
            //   <hash____> [String]: >#hash_bang< len: 10
            //   <host____> [String]: >sub.domain.com:1025< len: 19
            //   <hostname> [String]: >sub.domain.com< len: 14
            //   <href____> [String]: >https://usertes:pasword@sub.domain.com:1025/curl?one=two&three=rour&q=89.67.167.34&dwa=trzy&one=three#hash_bang< len: 111
            //   <origin__> [String]: >https://sub.domain.com:1025< len: 27
            //   <password> [String]: >pasword< len: 7
            //   <pathname> [String]: >/curl< len: 5
            //   <port____> [String]: >1025< len: 4
            //   <protocol> [String]: >https:< len: 6
            //   <search__> [String]: >?one=two&three=rour&q=89.67.167.34&dwa=trzy&one=three< len: 53
            //   <searchParams> [URLSearchParams]: >one=two&three=rour&q=89.67.167.34&dwa=trzy&one=three<
            //   <username> [String]: >usertes< len: 7
            //   <target> [String]: >https://usertes:pasword@sub.domain.com:1025/curl?one=two&three=rour&q=89.67.167.34&dwa=trzy&one=three< len: x
            //   <path> [String]: >/curl?one=two&three=rour&q=89.67.167.34&dwa=trzy&one=three< len: x
            //   <https___> [Boolean]: >true<
            //   <searchParams_all> Object {
            //     <one> Array [
            //       <0> [String]: >two< len: 3
            //       <1> [String]: >three< len: 5
            //     ]
            //     <three> Array [
            //       <0> [String]: >rour< len: 4
            //     ]
            //     <q> Array [
            //       <0> [String]: >89.67.167.34< len: 12
            //     ]
            //     <dwa> Array [
            //       <0> [String]: >trzy< len: 4
            //     ]
            //   }
            //   <using with http.request():> Object {
            //     <hostname> [String]: >sub.domain.com< len: 14
            //     <port> [String]: >1025< len: 4
            //     <path> [String]: >/curl< len: 5
            //     <method> [String]: >POST< len: 4
            //     <headers> Object {
            //       <Content-Type> [String]: >application/json< len: 16
            //     }
            //   }
            //   <url.parse> Url {
            //     <protocol> [String]: >https:< len: 6
            //     <slashes> [Boolean]: >true<
            //     <auth> [String]: >usertes:pasword< len: 15
            //     <host> [String]: >sub.domain.com:1025< len: 19
            //     <port> [String]: >1025< len: 4
            //     <hostname> [String]: >sub.domain.com< len: 14
            //     <hash> [String]: >#hash_bang< len: 10
            //     <search> [String]: >?one=two&three=rour&q=89.67.167.34&dwa=trzy&one=three< len: 53
            //     <query> [String]: >one=two&three=rour&q=89.67.167.34&dwa=trzy&one=three< len: 52
            //     <pathname> [String]: >/curl< len: 5
            //     <path> [String]: >/curl?one=two&three=rour&q=89.67.167.34&dwa=trzy&one=three< len: 58
            //     <href> [String]: >https://usertes:pasword@sub.domain.com:1025/curl?one=two&three=rour&q=89.67.167.34&dwa=trzy&one=three#hash_bang< len: 111
            //   }
            // }
          </script>
        </div>
        <h2>uncaughtException unhandledRejection</h2>
        <script type="editor" data-lang="sh">


          process.on("uncaughtException", (e) => {
            if (e instanceof Error) {
              console.log("global uncaughtException Error: ", {
                message: e && e.message ? e.message : '',
                stack: e && e.stack ? e.stack : '',
              });
            } else {
              console.log("global uncaughtException not Error: ", String(e));
            }
          });

          process.on("unhandledRejection", (e) => {
            if (e instanceof Error) {
              console.log("global unhandledRejection Error: ", {
                message: e && e.message ? e.message : '',
                stack: e && e.stack ? e.stack : '',
              });
            } else {
              console.log("global unhandledRejection not Error: ", String(e));
            }
          });
        </script>

        <div class="cards">
          <h2>component search</h2>
          <a href="https://openbase.io/js/node-xlsx">https://openbase.io/js/node-xlsx</a>
        </div>

        <div class="cards">
          <h2>safe console.log</h2>
          <script type="editor" data-lang="js">

            // just log
            var log=(function(){try{return console.log}catch(e){return function(){}}}());

            // tlog
            const tlog = (function () {

                var log=(function(){try{return console.log}catch(e){return function(){}}}());

                const time = () => (new Date()).toISOString().substring(0, 19).replace('T', ' ')

                return (...args) => {
                    log.call(this, time(), ...args.map(a => a + ''));
                }
            }());

            // module
            const log=(function(){try{return console.log}catch(e){return function(){}}}());

            const time = () => (new Date()).toISOString().substring(0, 19).replace('T', ' ')

            module.exports = (...args) => {
                log.call(this, time(), ...args.map(a => a + ''));
            }

            // node inspect
            const i = require('util').inspect;

            console.log(i(t, {
                depth:  50,
                colors: true,
                compact: true,
                // breakLength: 80,
            }))
          </script>
          <h2>cli arguments manual processing</h2>
          <script type="editor" data-lang="js">


            const args = (function (obj, tmp) {
              process.argv
                  .slice(2)
                  .map(a => {

                    if (a.indexOf('--') === 0) {

                      tmp = a.substring(2).replace(/^\s*(\S*(\s+\S+)*)\s*$/, '$1');

                      if (tmp) {

                        obj[tmp] = (typeof obj[tmp] === 'undefined') ? true : obj[tmp];
                      }

                      return;
                    }

                    if (a === 'true') {

                      a = true
                    }

                    if (a === 'false') {

                      a = false
                    }

                    if (tmp !== null) {

                      if (obj[tmp] === true) {

                        return obj[tmp] = [a];
                      }

                      try {

                        obj[tmp].push(a);
                      }
                      catch (e) {

                      }
                    }
                  })
              ;

              Object.keys(obj).map(k => {
                (obj[k] !== true && obj[k].length === 1) && (obj[k] = obj[k][0]);
                (obj[k] === 'false') && (obj[k] = false);
              });

              return {
                count: () => Object.keys(obj).length,
                all: () => JSON.parse(JSON.stringify(obj)),
                get: (key, def) => {

                  var t = JSON.parse(JSON.stringify(obj));

                  if (typeof def === 'undefined')

                    return t[key];

                  return (typeof t[key] === 'undefined') ? def : t[key] ;
                },
                string: (key, def) => {
                  var t = JSON.parse(JSON.stringify(obj));

                  return typeof t[key] === "string" ? t[key] : def;
                },
              };
            }({}));
          </script>
          <h2>jest</h2>
          <a href="https://github.com/stopsopa/roderic-legacy/tree/master/test/jest">https://github.com/stopsopa/roderic-legacy/tree/master/test/jest</a>

          <h2>update.sh - shell script</h2>
          <script type="editor" data-lang="sh">


            #!/bin/bash

            set -e

            set -x

            ORIGIN="origin"
            LOCALBRANCH="master"
            REMOTEBRANCH="master"

            trim() {
                local var="$*"
                # remove leading whitespace characters
                var="${var#"${var%%[![:space:]]*}"}"
                # remove trailing whitespace characters
                var="${var%"${var##*[![:space:]]}"}"
                echo -n "$var"
            }

            function red {
                printf "\e[31m$1\e[0m\n"
            }

            function green {
                printf "\e[32m$1\e[0m\n"
            }

            if [ "$(git rev-parse --abbrev-ref HEAD)" != $LOCALBRANCH ]; then

                red "switch first branch to <$LOCALBRANCH>"

                exit 1;
            fi

            green "\ncurrent branch: $LOCALBRANCH";

            DIFF="$(git diff --numstat)"

            DIFF="$(trim "$DIFF")"

            if [ "$DIFF" != "" ]; then

                red "\n\n    Error: First commit changes ...\n\n";

                exit 2;
            fi

            DIFF="$(git diff --numstat $LOCALBRANCH $ORIGIN/$REMOTEBRANCH)"

            DIFF="$(trim "$DIFF")"

            if [ "$DIFF" != "" ]; then

                git push $ORIGIN $REMOTEBRANCH --tags

                if [ "$?" != "0" ]; then

                    red "\n\nCan't git push - stop bumping version\n"

                    exit 3;
                fi

                npm version patch

                                        # node version-dep.js
                                        # git add package.json
                                        # git commit --amend --no-edit

                git push $ORIGIN $REMOTEBRANCH

                if [ "$?" = "0" ]; then

                    npm publish

                    if [ "$?" != "0" ]; then

                        red "\n\nCan't npm publish\n"

                        exit 4;
                    fi

                    git push --tags --force

                else

                    red "\n\nCan't git push\n"

                    exit 5
                fi

            else

                red "\n\n    Nothing new to publish\n\n";
            fi
          </script>
        </div>
        <div class="cards">
          <h2>Node clock controlled crush</h2>
          <script type="editor" data-lang="js">

            /*

            usage in server script:

            require('dotenv-up')({
              override    : false,
              deep        : 5,
            }, false, '..................');

            (function () {

              const atomclock = require('./app/lib/atomclock');

              atomclock.crashServer(process.env.PROTECTED_MYSQL_MAX_TIME_DIFF);
            }());

            */

            const log = require('inspc');

            const jsonfetch = require('./jsonfetch');

            const promiseany = require('nlab/promiseany');

            // const promiseall = require('nlab/promiseall');

            const emsg = msg => `atomclock.js error: ${msg}`

            const th = msg => new Error(emsg(msg));

            // module.exports = (warning = true) => promiseall([
            const tool = (warning = true) => promiseany([
              async atom => {

                try {

                  atom = await jsonfetch('http://worldtimeapi.org/api/timezone/Etc/UTC', {
                    timeout: 2000,
                  });

                  if ( ! Number.isInteger(atom.body.unixtime) ) {

                    throw th(`http://worldtimeapi.org/api/timezone/Etc/UTC unixtime is not an integer`);
                  }

                  return atom.body.unixtime;

                }
                catch (e) {

                  if (warning) {

                    log.dump({
                      atomclick_js_warning: e
                    })
                  }

                  throw e;
                }
              },
              async atom => {

                try {

                  atom = await jsonfetch('http://showcase.api.linx.twenty57.net/UnixTime/tounixtimestamp?datetime=now', {
                    timeout: 2000,
                  });

                  if (atom.status !== 200) {

                    throw th(`http://showcase.api.linx.twenty57.net/UnixTime/tounixtimestamp?datetime=now atom.status !== 200`);
                  }

                  if ( ! /^\d+$/.test(atom.body.UnixTimeStamp) ) {

                    throw th(`http://showcase.api.linx.twenty57.net/UnixTime/tounixtimestamp?datetime=now atom.body.UnixTimeStamp don't match /^\\d+$/`);
                  }

                  atom = parseInt(atom.body.UnixTimeStamp, 10);

                  if ( ! Number.isInteger(atom) ) {

                    throw th(`http://showcase.api.linx.twenty57.net/UnixTime/tounixtimestamp?datetime=now atom is not an integer`);
                  }

                  return atom;

                }
                catch (e) {

                  if (warning) {

                    log.dump({
                      atomclick_js_warning: e
                    })
                  }

                  throw e;
                }
              },
              async atom => {

                try {

                  atom = await jsonfetch('http://widget.time.is/', {
                    timeout: 2000,
                  });

                  if (atom.status !== 200) {

                    throw th(`http://worldclockapi.com/api/json/utc/now atom.status !== 200`);
                  }

                  atom = atom.body.replace(/^[^\d]+(\d+).*$/, '$1');

                  if ( ! /^\d+$/.test(atom) ) {

                    throw th(`http://worldclockapi.com/api/json/utc/now atom.status don't match /^\\d+$/`);
                  }

                  return parseInt(parseInt(atom, 10) / 1000, 10);

                }
                catch (e) {

                  if (warning) {

                    log.dump({
                      atomclick_js_warning: e
                    })
                  }

                  throw e;
                }
              },
            ]);

            tool.crashServer = async function (diff) {

              try {

                if ( typeof diff !== 'string' ) {

                  throw th(`diff is not a string`);
                }

                if ( ! /^\d+$/.test(diff || '') ) {

                  throw th(`atomclock.js diff (value: '${diff}') is not defined or it doesn't match /^\\d+$/`);
                }

                const crushnodeifdiffgreaterthansec = parseInt(diff, 10);

                const at = await tool(false);

                const now = parseInt((new Date()).getTime() / 1000, 10)

                const abs = Math.abs(at - now);

                if (abs > crushnodeifdiffgreaterthansec) {

                  throw th(`atomclock.js time - node UTC time differance '${abs}' is greater than '${crushnodeifdiffgreaterthansec}' sec`);
                }

                console.log(`Time differance between atomclock.js time and node.js clock time is '${abs}', should be smaller than ${crushnodeifdiffgreaterthansec}`)

                console.log("Time diff is small enough 👍")
              }
              catch (e) {

                log.dump({
                  atomclick_general_error: e
                })

                throw e;
              }
            }

            module.exports = tool;
          </script>
        </div>
        <div class="cards">
          <h2>Express template</h2>
          <script type="editor" data-lang="js">

            const path      = require('path');

            const fs        = require('fs');

            const express   = require('express');

            const log       = (function(){try{return console.log}catch(e){return function (){}}}());

            const template  = require('lodash/template');

            // https://www.npmjs.com/package/cookie-parser
            const cookieParser = require('cookie-parser');

            // https://stackoverflow.com/a/23613092
            const serveIndex    = require('serve-index');

            const host      = process.env.HOST;

            const port      = process.env.PORT;

            const web = path.resolve(__dirname, 'public');

            const readFile = file => fs.readFileSync(file).toString();

            const app       = express();

            app.use(cookieParser())

            app.use(express.urlencoded({extended: false}));

            app.use(express.json());

            app.all('/save', (req, res) => {

                const cookies = decodeURIComponent(req.headers.cookie || '').split(';').reduce((acc, coo) => {
                    const tmp   = coo.split('=');
                    const name  = tmp.shift().trim();
                    const value = tmp.join('=').trim();
                    name && (acc[name] = value);
                    return acc;
                }, {});

                log('save');
                log(JSON.stringify(req.body));

                res.setHeader('Content-type', 'application/json; charset=utf-8');
                res.end(JSON.stringify({
                    ok: true
                }));
            })

            app.all('/root', (req, res) => {

                const html  = readFile(path.resolve(__dirname, 'public', '_index.html'));

                const svg   = readFile(path.resolve(__dirname, 'public', 'tree.svg'));

                const tmp = template(html);

                res.end(tmp({
                    svg
                }));
            });

            app.use(express.static(web, { // http://expressjs.com/en/resources/middleware/serve-static.html
                // maxAge: 60 * 60 * 24 * 1000 // in milliseconds
                maxAge: '356 days', // in milliseconds max-age=30758400
                setHeaders: (res, path) => {

                    if (/\.bmp$/i.test(path)) { // for some reason by default express.static sets here Content-Type: image/x-ms-bmp

                        res.setHeader('Content-type', 'image/bmp')
                    }

                    // https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control
                    // res.setHeader('Cache-Control', 'public, no-cache, max-age=30758400')
                    // res.setHeader('Cache-Control', 'public, only-if-cached')
                }
            }), serveIndex(web, {
              icons: true,
              view: "details",
              hidden: false, // Display hidden (dot) files. Defaults to false.
            }));

            app.listen(port, host, () => {

                console.log(`\n 🌎  Server is running ` + `http://${host}:${port}\n`)
            });
          </script>
          <script type="editor" data-lang="json">
            {
              "dependencies": {
                "body-parser"    : "^1.18.3",
                "express"    : "^4.16.3",
                "lodash"    : "^4.17.10",
                "serve-index"    : "^1.9.1"
              }
            }
          </script>
        </div>

        <div class="cards">
          <h2>colors</h2>
          <a href="https://www.npmjs.com/package/colors">NPM - colors</a>
          <table width="100%">
            <tbody>
              <tr>
                <td>
                  <script type="editor" data-lang="js">
                    require('colors');
                    const l = c => console.log(`${c} [` + (`test string`[c]) + ']');
                    console.log("\n\n");
                    // text colors
                    l('black');
                    l('red');
                    l('green');
                    l('yellow');
                    l('blue');
                    l('magenta');
                    l('cyan');
                    l('white');
                    l('gray');
                    l('grey');
                    // bg colors
                    l('bgBlack');
                    l('bgRed');
                    l('bgGreen');
                    l('bgYellow');
                    l('bgBlue');
                    l('bgMagenta');
                    l('bgCyan');
                    l('bgWhite');
                    //styles
                    l('reset');
                    l('bold');
                    l('dim');
                    l('italic');
                    l('underline');
                    l('inverse');
                    l('hidden');
                    l('strikethrough');
                    //extras
                    l('rainbow');
                    l('zebra');
                    l('america');
                    l('trap');
                    l('random');
                    console.log("\n\n")
                  </script>
                </td>
                <td width="257">
                  <img src="/img/node/colors.png" height="624" />
                </td>
              </tr>
            </tbody>
          </table>
          <table width="100%">
            <tbody>
              <tr>
                <td>
                  <script type="editor" data-lang="js">

                    const c = {
                      Bright      : "\x1b[1m",
                      Dim         : "\x1b[2m",
                      Underscore  : "\x1b[4m",
                      Blink       : "\x1b[5m",
                      Reverse     : "\x1b[7m",
                      Hidden      : "\x1b[8m",
                      FgBlack     : "\x1b[30m",
                      FgRed       : "\x1b[31m", // red
                      FgGreen     : "\x1b[32m", // green
                      FgYellow    : "\x1b[33m", // yellow
                      FgBlue      : "\x1b[34m",
                      FgMagenta   : "\x1b[35m", // magenta
                      FgCyan      : "\x1b[36m", // cyan
                      FgWhite     : "\x1b[37m",
                      BgBlack     : "\x1b[40m",
                      BgRed       : "\x1b[41m",
                      BgGreen     : "\x1b[42m",
                      BgYellow    : "\x1b[43m",
                      BgBlue      : "\x1b[44m",
                      BgMagenta   : "\x1b[45m",
                      BgCyan      : "\x1b[46m",
                      BgWhite     : "\x1b[47m",
                      r           : "\x1b[31m", // red
                      g           : "\x1b[32m", // green
                      y           : "\x1b[33m", // yellow
                      m           : "\x1b[35m", // magenta
                      c           : "\x1b[36m", // cyan
                      reset       : "\x1b[0m",
                    };

                    Object.keys(c).forEach((key) => {
                      console.log(`${c[key]}${key} ${key} ${key}${c.reset} >${key}<`);
                    });
                  </script>
                </td>
                <td width="257">
                  <img src="https://i.imgur.com/bawTURW.png" style="width: 480px" />
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="cards">
          <h2>request.js</h2>
          <script type="editor" data-lang="js">

            // tests: https://github.com/stopsopa/vault/blob/master/test/request.test.js

            const URL = require('url').URL;

            const https = require('https');

            const http = require('http');

            // npm WARN deprecated querystring@0.2.0: The querystring API is considered Legacy. new code should use the URLSearchParams API instead.
            const querystring = require('querystring');

            const se = require('nlab/se');

            const th = msg => new Error(`request: ${String(msg)}`);

            const log = console.log;

            const isObject = require('nlab/isObject');

            module.exports = function request(url, opt = {}) {

                let {
                    method = 'GET',
                    body = undefined,
                    query = {},
                    headers = {},
                    timeout = 30 * 1000, // 30 sec
                    verbose = false,
                    decodeJson = true,
                } = opt;

                if (typeof method !== 'string') {

                    throw th(`method is not a string`);
                }

                method = method.toUpperCase();

                let rq;

                return new Promise((resolve, reject) => {

                    const uri = new URL(url);

                    const lib = (uri.protocol === 'https:') ? https : http;

                    query = querystring.stringify(query);

                    rq = {
                        hostname: uri.hostname,
                        port: uri.port || ((uri.protocol === 'https:') ? '443' : '80'),
                        path: uri.pathname + uri.search + (query ? (uri.search.includes('?') ? '&' : '?') + query : ''),
                        method,
                        headers,
                    };

                    if (Array.isArray(body) || isObject(body)) {

                        if (method === 'GET') {

                            throw th(`body looks like json payload but request method is GET`);
                        }

                        // modyfying original 'rq' by reference
                        headers['Content-type'] = 'application/json; charset=utf-8';
                    }

                    if (verbose) {

                        log({
                            'request.js': rq,
                        })
                    }

                    var req = lib.request(rq, res => {

                        res.setEncoding('utf8');

                        let body = '';

                        res.on('data', chunk => {

                            body += chunk
                        });

                        res.on('end', () => {

                            try {

                                if (decodeJson && (res.headers['content-type'] || '').includes('application/json')) {

                                    body = JSON.parse(body);
                                }

                                resolve({
                                    status: res.statusCode,
                                    headers: res.headers,
                                    body,
                                })
                            }
                            catch (e) {

                                if (verbose) {

                                    log({
                                        request_resolve_exception_catch: se(e),
                                    })
                                }

                                reject({
                                    type: 'endevent',
                                    data: se(e),
                                });
                            }
                        });
                    });

                    req.on('socket', function (socket) { // uncomment this to have timeout

                        socket.setTimeout(timeout);

                        socket.on('timeout', () => { // https://stackoverflow.com/a/9910413

                            try {
                                req.destroy();
                            }
                            catch (e) {
                                try {
                                    req.abort(); // since v14.1.0 Use request.destroy() instead
                                }
                                catch (e) { }
                            }

                            reject({
                                type: 'timeout',
                                data: `timeout (${timeout}ms)`,
                            })
                        });
                    });

                    req.on('error', e => reject({
                        type: 'error',
                        data: se(e)
                    }));

                    if (Array.isArray(body) || isObject(body)) {

                        req.write(JSON.stringify(body));
                    }

                    req.end();
                });
            }
          </script>
        </div>

        <div class="cards">
          <h2>lightfetch.js</h2>
          <a href="https://github.com/stopsopa/nlab/blob/master/src/lightFetch.js">https://github.com/stopsopa/nlab/blob/master/src/lightFetch.js</a>
          <h2>curl polyfill</h2>
          <script type="editor" data-lang="sh" class="domain.com">

            wget --help 1> /dev/null 2> /dev/null
            if [ "$?" = "0" ]; then
              wget --no-cache -O "curl.js" "domain.com/pages/node/curl.js"
            else # curl
              curl "domain.com/pages/node/curl.js" -o "curl.js"
            fi
          </script>
          <a href="https://httpstat.us/">https://httpstat.us/</a>
        </div>
        <div class="cards">
          <h2>fetchData & fetchJson (transport.js)</h2>
          <script type="editor" data-lang="js">


            // yarn add nlab node-fetch cross-fetch

            const isNode        = require('nlab/isNode');

            const negotiatePort = require('nlab/negotiatePort');

            const isObject      = require("nlab/isObject");

            const log           = (function(){try{return console.log}catch(e){return()=>{}}}());

            const th = msg => new Error(`transport.js error: ${msg}`);

            let fakeFetch;

            let origin;

            /**
              PROTOCOL="http"
              HOST="0.0.0.0"
              PORT="8080"
            */
            function setFetch(PROTOCOL, HOST, PORT) {

              if ( ! /^https?$/.test(PROTOCOL) ) {

                throw th(`PROTOCOL (${PROTOCOL}) don't match /^https?$/`);
              }

              if ( typeof HOST !== 'string' ) {

                throw th(`HOST (${HOST}) is not a string`);
              }

              if ( ! HOST.trim() ) {

                throw th(`HOST is an empty string`);
              }

              origin = `${PROTOCOL}://${HOST}` + negotiatePort(PROTOCOL, PORT, ':');
            }

            if ( isNode ) {

              fakeFetch = eval('require')('node-fetch');
            }
            else {

              (function (old) {

                const fetchPolyfill = require('cross-fetch');

                console.log('fetchPolyfill', fetchPolyfill)

                fakeFetch = window.fakeFetch = (url, opt) => {

                  log(`ajax fetch polyfill ${url}`);

                  return fetchPolyfill(url, opt);
                };

                if (old) {

                  window.fetch = (url, opt) => {

                    log(`native fetch ${url}`);

                    return old(url, opt);
                  };
                }
              })(window.fetch);
            }

            const fetchData = async (path, options) => {

              if (typeof options === "undefined") {

                options = {};
              }

              if ( origin && ! /^https?:\/\//.test(path) ) {

                path = origin + path;
              }

              log(`fetchData path: ${path}`);

              options.headers = {
                "x-requested-with"    : "fetch",
                ...options.headers,
              };

              const { delay, native, ...rest } = options;

              options = rest;

              if (Number.isInteger(delay) && delay > 0) {

                await new Promise(res => setTimeout(res, delay));
              }

              if ( native && ! isNode && window.fetch) {

                return window.fetch(path, options);
              }

              return fakeFetch(path, options);
            };

            const fetchJson = (path, options) => {

              if (typeof options === "undefined") {

                options = {};
              }

              options.headers = {
                "Content-Type"    : "application/json; charset=utf-8",
                Accept    : "application/json",
                ...options.headers,
              };

              if (isObject(options.body) || Array.isArray(options.body)) {

                options.body = JSON.stringify(options.body || {}, null, 4);

                options.method = options.method || "POST";
              } else {

                options.method = options.method || "GET";
              }

              const { rawResponse, ...rest } = options;

              const res = fetchData(path, rest);

              if (rawResponse) {

                return res;
              }

              return res.then(res => res.json());
            };

            if ( ! isNode ) {

              window.fetchData = fetchData;

              window.fetchJson = fetchJson;
            }

            module.exports = {
              fakeFetch,
              fetchData,
              fetchJson,
              setFetch,
            }
          </script>
        </div>

        <div class="cards">
          <h2>nvm</h2>
          <a href="https://nodejs.org/en/about/releases/">https://nodejs.org/en/about/releases/</a>
          <script type="editor" data-lang="sh">

            nvm ls
            nvm install [version]
            nvm use [version]
            .nvmrc
            nvm alias default v16.16.0
            nvm ls-remote

            nvm install --lts
            nvm use --lts
          </script>
          <h2>csv</h2>
          <a href="https://www.npmjs.com/package/@fast-csv/format">https://www.npmjs.com/package/@fast-csv/format</a>
        </div>

        <div class="cards">
          <h2>base64</h2>
          <script type="editor" data-lang="sh">

            Buffer.from(json).toString('base64')
            Buffer.from(base64, 'base64').toString('ascii');
          </script>
          <h2>md5</h2>
          <script type="editor" data-lang="sh">


            // equal to:
            // echo -n fdsadas | md5
            function md5(str, cut) {
              const md5 = crypto.createHash("md5").update(str).digest("hex");

              if (typeof cut === "number" && Number.isInteger(cut)) {
                if (cut < 5) {
                  throw new Error(`md5 cut is smaller than 5`);
                }

                return md5.substring(0, cut);
              }

              return md5;
            }
          </script>
          <h2>Read more</h2>
          <a href="https://fjolt.com/article/javascript-shadowrealms">https://fjolt.com/article/javascript-shadowrealms</a>
        </div>

        <div class="cards">
          <h2>excel xlsx</h2>
          <script type="editor" data-lang="js">

            const express   = require('express'); // "exceljs"    : "3.8.0" for node version v8.15.1

            const host      = '0.0.0.0';

            const port      = 8989;

            const app       = express();

            const Excel = require('exceljs');

            app.all('/root', async (req, res) => {

              console.log('/root')

              // https://stackoverflow.com/a/55166212
              const workbook = new Excel.Workbook();
              const worksheet = workbook.addWorksheet("My Sheet");

              worksheet.columns = [
                {header: 'Id', key: 'id', width: 10},
                {header: 'Name', key: 'name', width: 32},
                {header: 'D.O.B.', key: 'dob', width: 15,}
              ];

              worksheet.addRow({
                id: 1,
                name: 'John Doe',
                dob: new Date(1970, 1, 1)
              });

              // save under export.xlsx
              // await workbook.xlsx.writeFile('export.xlsx');

              // https://github.com/exceljs/exceljs/issues/37#issuecomment-181772680
              res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
              res.setHeader("Content-Disposition", "attachment; filename=" + "export.xlsx");

              await workbook.xlsx.write(res);

              res.end();
            });

            app.listen(port, host, () => {

              console.log(`\n 🌎  Server is running ` + `${host}:${port}\n`)
            });
          </script>
        </div>

        <div class="cards">
          <h2>cmd promise</h2>
          <script type="editor" data-lang="js">

            const { spawn } = require("child_process");

            const se = require('nlab/se');

            const th    = msg => new Error(`${__filename} error: ${msg}`);

            /**
             * Running:
             *
             const data = await cmd([
             'ls',
             '-la',
             '/Users/sd/Workspace/projects/monorepo/monorepo-master/a b c/test'
             ]);
             will work for directory with spacec in name
             */

            module.exports = (cmd, opt) => new Promise((resolve, reject) => {

              if (typeof cmd === 'string') {

                cmd = cmd.trim();

                if ( ! cmd ) {

                  throw th(`cmd is an empty string`);
                }

                cmd = cmd.split(/\s+/);
              }

              if ( ! Array.isArray(cmd) ) {

                throw th(`cmd is not an array`);
              }

              if ( ! cmd.length) {

                throw th(`cmd is an empty array`);
              }

              const {
                verbose = false,
              } = {...opt};

              verbose && console.log(`executing command ${c.g(cmd.join(' '))}`)

              const [command, ...args] = cmd;

              const process = spawn(command, args);

              let stdout = '';

              let stderr = '';

              process.stdout.on("data", data => {
                stdout += String(data);
              });

              process.stderr.on("data", data => {
                stderr += String(data);
              });

              process.on('error', (e) => {

                verbose && console.log(`error: ${e.message}`);

                reject({
                  cmd,
                  stdout,
                  stderr,
                  e: se(e)
                });
              });

              process.on("close", code => {

                verbose && console.log(`child process ${c.g(cmd.join(' '))} exited with code ${code}`);

                if (code !== 0) {

                  return reject({
                    cmd,
                    stdout,
                    stderr,
                    code,
                  });
                }

                resolve({
                  cmd,
                  stdout,
                  stderr,
                  code,
                });
              });
            })
          </script>
          global settings and other stuff:

          <script type="editor" data-lang="sh">

            cat <<EEE > ~/.huskyrc
            export PATH="${PATH}:/Users/sdzialowski/.nvm/versions/node/v16.14.0/bin"
            EEE
            # concluded from: https://github.com/typicode/husky/issues/898

            yarn husky add .husky/pre-commit 'docker run --rm -v "$(pwd):/git" godaddy/tartufo --output-dir /git/.tartufo --config /git/tartufo.toml pre-commit'
            yarn husky add .husky/pre-push 'echo pre push'
          </script>
          <a href="https://github.com/semantic-release/semantic-release">see also semantic-release</a>

          <h2>Learning promises</h2>
          <h5>Always await promises before returning to avoid a partial stacktrace</h5>
          <a href="https://github.com/goldbergyoni/nodebestpractices#-212-always-await-promises-before-returning-to-avoid-a-partial-stacktrace"
            >https://github.com/goldbergyoni/nodebestpractices#-212-always-await-promises-before-returning-to-avoid-a-partial-stacktrace</a
          >
          <br />
          <a href="https://github.com/goldbergyoni/nodebestpractices/blob/master/sections/errorhandling/returningpromises.md"
            >https://github.com/goldbergyoni/nodebestpractices/blob/master/sections/errorhandling/returningpromises.md</a
          >
          <script type="editor" data-lang="js">

            /**
             * https://github.com/goldbergyoni/nodebestpractices#-212-always-await-promises-before-returning-to-avoid-a-partial-stacktrace
             * Always await promises before returning to avoid a partial stacktrace
             */

            function wait (ms) {

              return new Promise(res => setTimeout(res, ms, `wait ${ms}`))
            }

            async function th() {

              await wait(200);

              throw new Error(`th error`);
            }

            async function b() {

              await wait(200);

              // return th(); // uncomment this line to see error without one stack point, as below
              // {
              //   main_catch: {
              //     message: 'th error',
              //       stack: 'Error: th error\n' +
              //     '    at th (/Users/sdzialowski/Workspace/PEX_dev/PEX__wax-api/runtime/t.js:16:9)\n' +
              //     '    at async /Users/sdzialowski/Workspace/PEX_dev/PEX__wax-api/runtime/t.js:49:5'
              //   }
              // }

              return await th();
              // {
              //   main_catch: {
              //     message: 'th error',
              //       stack: 'Error: th error\n' +
              //     '    at th (/Users/sdzialowski/Workspace/PEX_dev/PEX__wax-api/runtime/t.js:16:9)\n' +
              //     '    at async b (/Users/sdzialowski/Workspace/PEX_dev/PEX__wax-api/runtime/t.js:33:10)\n' +
              //     '    at async /Users/sdzialowski/Workspace/PEX_dev/PEX__wax-api/runtime/t.js:49:5'
              //   }
              // }
            };

            (async function () {

              try {

                await b()
              }
              catch (e) {

                console.log({
                  main_catch: {
                    message: e.message,
                    stack: e.stack,
                  }
                })
              }
            }());
          </script>
          <h2>yield</h2>
          <script type="editor" data-lang="js">

            const t = ['one', 'two', 'three', 'four'];
            let error;
            // error = 1;
            // error = 2;
            function* foo(t) {
              console.log('start');
              if (error === 1) {
                throw new Error(`What's happened?! 1`);
              }
              for (let i = 0, l = t.length ; i < l ; i += 1 ) {
                console.log(`stop: ${i}`);
                if (error === 2) {
                  throw new Error(`What's happened?! 2`);
                }
                yield `${t[i]} yield`;
              }
              return 'finish'
            }
            let iterator;
            try {
              iterator = foo(t);
              console.log('after iterator');
            }
            catch (e) {
              console.log('generalerror: ', String(e));
            }
            try {
              console.log('1:', iterator.next());
              console.log('2:', iterator.next('myval'));
              console.log('3:', iterator.next());
              console.log('4:', iterator.next());
              console.log('5:', iterator.next());
              console.log('6:', iterator.next());
            }
            catch (e) {
              console.log('generalerror 2: ', String(e));
            }

            // // for error = undefined
            // after iterator
            // start
            // stop: 0
            // 1: { value: 'one yield', done: false }
            // stop: 1
            // 2: { value: 'two yield', done: false }
            // stop: 2
            // 3: { value: 'three yield', done: false }
            // stop: 3
            // 4: { value: 'four yield', done: false }
            // 5: { value: 'finish', done: true }
            // 6: { value: undefined, done: true }
            //
            // // for error = 1
            // after iterator
            // start
            // generalerror 2:  Error: What's happened?! 1
            //
            // // for error = 2
            // after iterator
            // start
            // stop: 0
            // generalerror 2:  Error: What's happened?! 2
          </script>
          <h2>Stress test - artillery</h2>
          <a href="https://www.npmjs.com/package/autocannon">alternatively there can be used "autocannon"</a>
          <script type="editor" data-lang="js">
            /*

            # there is issue reported regarding second request: https://github.com/artilleryio/artillery/issues/1508

            mkdir __test
            cd __test
            echo "{}" > package.json
            yarn add "express@4.18.1" "nodemon@2.0.19" "serve-index@1.9.1"

            echo -e "this one will be sent whole\nadmiring\nadoring\naffectionate\nagitated\namazing\nangry\nawesome\nbeautiful\nblissful\nbold\nboring\nbrave\nbusy\ncharming\nclever\ncool\ncompassionate\ncompetent\ncondescending\nconfident\ncranky\ncrazy\ndazzling\ndetermined\ndistracted\ndreamy\neager\necstatic\nelastic\nelated\nelegant\neloquent\nepic\nexciting\nfervent\nfestive\nflamboyant\nfocused\nfriendly\nfrosty\nfunny\ngallant\ngifted\ngoofy\ngracious\ngreat\nhappy\nhardcore\nheuristic\nhopeful\nhungry\ninfallible\ninspiring\nintelligent\ninteresting\njolly\njovial\nkeen\nkind\nlaughing\nloving\nlucid\nmagical\nmystifying\nmodest\nmusing\nnaughty\nnervous\nnice\nnifty\nnostalgic\nobjective\noptimistic\npeaceful\npedantic\npensive\npractical\npriceless\nquirky\nquizzical\nrecursing\nrelaxed\nreverent\nromantic\nsad\nserene\nsharp\nsilly\nsleepy\nstoic\nstrange\nstupefied\nsuspicious\nsweet\ntender\nthirsty\ntrusting\nunruffled\nupbeat\nvibrant\nvigilant\nvigorous\nwizardly\nwonderful\nxenodochial\nyouthful\nzealous\nzen\nagnesi\nalbattani\nallen\nalmeida\nantonelli\narchimedes\nardinghelli\naryabhata\naustin\nbabbage\nbanach\nbanzai\nbardeen\nbartik\nbassi\nbeaver\nbell\nbenz\nbhabha\nbhaskara\nblack\nblackburn\nblackwell\nbohr\nbooth\nborg\nbose\nbouman\nboyd\nbrahmagupta\nbrattain\nbrown\nbuck\nburnell\ncannon\ncarson\ncartwright\ncarver\ncerf\nchandrasekhar\nchaplygin\nchatelet\nchatterjee\nchaum\nchebyshev\nclarke\ncohen\ncolden\ncori\ncray\ncurran\ncurie\ndarwin\ndavinci\ndewdney\ndhawan\ndiffie\ndijkstra\ndirac\ndriscoll\ndubinsky\neasley\nedison\neinstein\nelbakyan\nelgamal\nelion\nellis\nengelbart\neuclid\neuler\nfaraday\nfeistel\nfermat\nfermi\nfeynman\nfranklin\ngagarin\ngalileo\ngalois\nganguly\ngates\ngauss\ngermain\ngoldberg\ngoldstine\ngoldwasser\ngolick\ngoodall\ngould\ngreider\ngrothendieck\nhaibt\nhamilton\nhaslett\nhawking\nhellman\nheisenberg\nhermann\nherschel\nhertz\nheyrovsky\nhodgkin\nhofstadter\nhoover\nhopper\nhugle\nhypatia\nishizaka\njackson\njang\njemison\njennings\njepsen\njohnson\njoliot\njones\nkalam\nkapitsa\nkare\nkeldysh\nkeller\nkepler\nkhayyam\nkhorana\nkilby\nkirch\nknuth\nkowalevski\nlalande\nlamarr\nlamport\nleakey\nleavitt\nlederberg\nlehmann\nlewin\nlichterman\nliskov\nlovelace\nlumiere\nmahavira\nmargulis\nmatsumoto\nmaxwell\nmayer\nmccarthy\nmcclintock\nmclaren\nmclean\nmcnulty\nmendel\nmendeleev\nmeitner\nmeninsky\nmerkle\nmestorf\nmirzakhani\nmontalcini\nmoore\nmorse\nmurdock\nmoser\nnapier\nnash\nneumann\nnewton\nnightingale\nnobel\nnoether\nnorthcutt\nnoyce\npanini\npare\npascal\npasteur\npayne\nperlman\npike\npoincare\npoitras\nproskuriakova\nptolemy\nraman\nramanujan\nride\nritchie\nrhodes\nrobinson\nroentgen\nrosalind\nrubin\nsaha\nsammet\nsanderson\nsatoshi\nshamir\nshannon\nshaw\nshirley\nshockley\nshtern\nsinoussi\nsnyder\nsolomon\nspence\nstonebraker\nsutherland\nswanson\nswartz\nswirles\ntaussig\ntereshkova\ntesla\ntharp\nthompson\ntorvalds\ntu\nturing\nvarahamihira\nvaughan\nvillani\nvisvesvaraya\nvolhard\nwescoff\nwilbur\nwiles\nwilliams\nwilliamson\nwilson\nwing\nwozniak\nwright\nwu\nyalow\nyonath\nzhukovsky" > keywords.csv
            # from https://github.com/moby/moby/blob/master/pkg/namesgenerator/names-generator.go

            cat <<EOF > artillery.yaml
            config:
              target: http://0.0.0.0:4236
              phases:
                - duration: 15
                  arrivalRate: 5
                  name: Warm up
                - duration: 15
                  arrivalRate: 5
                  rampTo: 50
                  name: Ramp up load
                - duration: 15
                  arrivalRate: 50
                  name: Sustained load
              payload:
                path: keywords.csv
                fields:
                  - keyword
            before:
              flow:
                - log: "Get auth token"
                - post:
                    url: "/artillery"
                    json:
                      jeb: "sie"
                    capture:
                      - json: "\$.body.jeb"
                        as: "nohoho"
            scenarios:
              - name: "Search and buy"
                flow:
                  - post:
                      url: "/artillery/{{ nohoho }}"
                      json:
                        auth: "c:{{ nohoho }}"
                        first_param: "{{ keyword }}"
                      capture:
                        - json: "\$.body.postparam"
                          as: "cap1"
                  - think: 1
                  - get:
                      url: "/artillery/{{ cap1 }}"

            EOF

            create server.js, code for it you'll find when you scroll down

            # in one terminal

            node node_modules/.bin/nodemon server.js

            # then in second

            curl -H "Content-type: application/json; charset=utf-8" -XPOST -d '{"postparam":"bodyval"}' "http://0.0.0.0:4236/artillery/something?abc=def&ghi=jkl"

            artillery run --output report.json artillery.yaml
            artillery report report.json

            then visit
                http://0.0.0.0:4236/report.json.html

            # more:
            # https://www.artillery.io/docs/guides/guides/command-line
            # https://www.artillery.io/docs/guides/getting-started/writing-your-first-test

            */


            const express = require("express");

            const serveIndex = require("serve-index");

            const app = express();

            app.use(express.json());

            app.set("json spaces", 4);

            let i = 0;
            app.all("/artillery/:param?", (req, res, next) => {
              let k = ++i;

              console.log(
                JSON.stringify([
                  String(k).padEnd(6, " "),
                  req.method,
                  req.url,
                  "query:",
                  req.query,
                  "body:",
                  req.body,
                ])
              );

              res.json({
                method: req.method,
                url: req.url,
                headers: req.headers,
                query: req.query,
                body: req.body,
                params: req.params,
              });
            });

            app.use(
              express.static(__dirname),
              serveIndex(__dirname, {
                icons: true,
                view: "details",
              })
            );

            const host = "0.0.0.0";

            const port = 4236;

            app.listen(port, host, () => {
              console.log("\n 🌎  Server is running http://" + host + ":" + port + "\n");
            });
          </script>
        </div>
      </div>
    </div>
    <script src="/js/github.js"></script>
  </body>
</html>
