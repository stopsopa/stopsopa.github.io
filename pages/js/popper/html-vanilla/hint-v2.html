<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      #handler {
        position: absolute;
        width: max-content;
        span {
          border: 1px solid #ccc;
          cursor: pointer;
          padding: 3px;
          user-select: none;
        }
        border: 1px solid blueviolet;
        padding: 5px;
      }
      .radios {
        display: inline-grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 5px;
        padding: 10px;
        border: 1px solid #ccc;
        label {
          display: flex;
          align-items: center;
          gap: 5px;
          padding: 3px 8px;
          border: 1px solid #eee;
          cursor: pointer;
        }
        label:hover {
          background: #f9f9f9;
        }
      }
      [popovertarget="mypopover"] {
        anchor-name: --anchor-el;
      }
      #mypopover {
        inset: auto;
        margin: 0;
        position-anchor: --anchor-el;
        width: max-content;
        /* Universal solution: try to flip block (top/bottom) or inline (left/right) 
           if the preferred side overflows the viewport. */
        position-try: flip-block, flip-inline;
        --offset: 10px;
      }
      /* 9 cardinal positions */
      #mypopover.topleft {
        bottom: calc(anchor(top) + var(--offset));
        right: anchor(left);
      }
      #mypopover.top {
        bottom: calc(anchor(top) + var(--offset));
        justify-self: anchor-center;
      }
      #mypopover.topright {
        bottom: calc(anchor(top) + var(--offset));
        left: anchor(right);
      }
      #mypopover.left {
        right: calc(anchor(left) + var(--offset));
        align-self: anchor-center;
      }
      #mypopover.center {
        justify-self: anchor-center;
        align-self: anchor-center;
      }
      #mypopover.right {
        left: calc(anchor(right) + var(--offset));
        align-self: anchor-center;
      }
      #mypopover.bottomleft {
        top: calc(anchor(bottom) + var(--offset));
        right: anchor(left);
      }
      #mypopover.bottom {
        top: calc(anchor(bottom) + var(--offset));
        justify-self: anchor-center;
      }
      #mypopover.bottomright {
        top: calc(anchor(bottom) + var(--offset));
        left: anchor(right);
      }
    </style>
  </head>
  <body>
    <div class="radios">
      <label title="topleft"> <input type="radio" name="position" value="topleft" /> </label>
      <label title="top"> <input type="radio" name="position" value="top" /> </label>
      <label title="topright"> <input type="radio" name="position" value="topright" /> </label>

      <label title="left"> <input type="radio" name="position" value="left" /> </label>
      <label title="center"> <input type="radio" name="position" value="center" /> </label>
      <label title="right"> <input type="radio" name="position" value="right" /> </label>

      <label title="bottomleft"> <input type="radio" name="position" value="bottomleft" /> </label>
      <label title="bottom"> <input type="radio" name="position" value="bottom" /> </label>
      <label title="bottomright"> <input type="radio" name="position" value="bottomright" /> </label>
    </div>
    <div style="margin-top: 10px">
      Offset: <input type="range" id="offsetRange" min="0" max="100" />
      <span id="offsetVal"></span>
      <label style="margin-left: 20px">
        <input type="checkbox" id="blockHorizontal" /> block horizontal checkbox
      </label>
    </div>
    <hr />
    <div id="handler">
      <span>Dragging Handler</span>
      <button popovertarget="mypopover">This is anchor: Toggle the popover</button>
      <span>Dragging Handler</span>
    </div>
    <div id="mypopover" popover="manual" contenteditable>
      This is popover [contenteditable]
      <button popovertarget="mypopover" popovertargetaction="hide">Close</button>
    </div>

    <script type="module">
      import handleRadio from "../../../html/handleRadio.js";

      function getStyle(el) {
        return window.getComputedStyle(el);
      }
      function drag(element, listener, fetch) {
        let pageX = 0;
        let pageY = 0;
        let down = false;
        let fetchX;
        let fetchY;
        function mousedown(e) {
          down = true;
          pageX = e.pageX;
          pageY = e.pageY;
          if (typeof fetch === "function") {
            ({ x: fetchX, y: fetchY } = fetch());
          } else {
            fetchX = fetchY = 0;
          }
          listener(fetchX + e.pageX - pageX, fetchY + e.pageY - pageY, "mousedown");
          function mousemove(e) {
            if (down) {
              listener(fetchX + e.pageX - pageX, fetchY + e.pageY - pageY, "mousemove");
            }
          }
          document.addEventListener("mouseup", (e) => {
            document.removeEventListener("mousemove", mousemove);
            if (down) {
              down = false;
              listener(fetchX + e.pageX - pageX, fetchY + e.pageY - pageY, "mouseup");
            }
          });
          document.addEventListener("mousemove", mousemove);
        }
        element.addEventListener("mousedown", mousedown);
      }

      const element = document.querySelector('[popovertarget="mypopover"]').parentNode;

      drag(
        element,
        (x, y) => {
          element.style.left = `${x}px`;
          element.style.top = `${y}px`;
        },
        () => {
          const s = getStyle(element);
          return { x: parseInt(s.left, 10) || 0, y: parseInt(s.top, 10) || 0 };
        }
      );

      function radioChange(value) {
        const popover = document.getElementById("mypopover");
        popover.classList.remove(
          "topleft",
          "top",
          "topright",
          "left",
          "center",
          "right",
          "bottomleft",
          "bottom",
          "bottomright"
        );
        popover.classList.add(value);
        console.log("radioChanged: ", value);
      }

      handleRadio({
        name: "position",
        delegateParent: document.querySelector(".radios"),
        initState: "top",
        initTrigger: true,
        onChange: radioChange,
      });

      const popover = document.getElementById("mypopover");

      popover.showPopover(); // enable by default

      const offsetRange = document.getElementById("offsetRange");
      const offsetVal = document.getElementById("offsetVal");

      // Initialize from CSS
      const initialOffset = getComputedStyle(popover).getPropertyValue("--offset").trim();
      const initialValue = parseInt(initialOffset, 10) || 0;
      offsetRange.value = initialValue;
      offsetVal.textContent = `${initialValue}px`;

      offsetRange.addEventListener("input", (e) => {
        const val = e.target.value;
        popover.style.setProperty("--offset", `${val}px`);
        offsetVal.textContent = `${val}px`;
      });

      const blockHorizontal = document.getElementById("blockHorizontal");
      blockHorizontal.addEventListener("change", (e) => {
        document.body.style.overflowX = e.target.checked ? "hidden" : "auto";
      });
    </script>
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <hr />
  </body>
</html>
