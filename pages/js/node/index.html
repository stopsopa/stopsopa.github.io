<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>stopsopa.github.io</title>
    <script src="/js/github.js"></script>
</head>
<body class="layout" head foot>

    <div class="body">
        <div class="inside">

            <div class="cards">
                <h2>update.sh - shell script</h2>               
                <script type="editor" data-lang="bash">


#!/bin/bash

set -e

set -x

ORIGIN="origin"
LOCALBRANCH="master"
REMOTEBRANCH="master"

trim() {
    local var="$*"
    # remove leading whitespace characters
    var="${var#"${var%%[![:space:]]*}"}"
    # remove trailing whitespace characters
    var="${var%"${var##*[![:space:]]}"}"
    echo -n "$var"
}

function red {
    printf "\e[31m$1\e[0m\n"
}

function green {
    printf "\e[32m$1\e[0m\n"
}

if [ "$(git rev-parse --abbrev-ref HEAD)" != $LOCALBRANCH ]; then

    red "switch first branch to <$LOCALBRANCH>"

    exit 1;
fi

green "\ncurrent branch: $LOCALBRANCH";

DIFF="$(git diff --numstat)"

DIFF="$(trim "$DIFF")"

if [ "$DIFF" != "" ]; then

    red "\n\n    Error: First commit changes ...\n\n";

    exit 2;
fi

DIFF="$(git diff --numstat $LOCALBRANCH $ORIGIN/$REMOTEBRANCH)"

DIFF="$(trim "$DIFF")"

if [ "$DIFF" != "" ]; then

    git push $ORIGIN $REMOTEBRANCH --tags

    if [ "$?" != "0" ]; then

        red "\n\nCan't git push - stop bumping version\n"

        exit 3;
    fi

    npm version patch

                            # node version-dep.js
                            # git add package.json
                            # git commit --amend --no-edit

    git push $ORIGIN $REMOTEBRANCH

    if [ "$?" = "0" ]; then

        npm publish

        if [ "$?" != "0" ]; then

            red "\n\nCan't npm publish\n"

            exit 4;
        fi

        git push --tags --force

    else

        red "\n\nCan't git push\n"

        exit 5
    fi

else

    red "\n\n    Nothing new to publish\n\n";
fi

                </script>
            </div>
            <div class="cards">
                <h2>Server template</h2>               
                <script type="editor" data-lang="js">

const path      = require('path');

const fs        = require('fs');

const express   = require('express');

const app       = express();

const log       = (function(){try{return console.log}catch(e){return function (){}}}());

const template  = require('lodash/template');

// https://stackoverflow.com/a/23613092
const serveIndex    = require('serve-index');

const bodyParser    = require('body-parser');

const host      = process.env.HOST;

const port      = process.env.PORT;

const web = path.resolve(__dirname, 'public');

const readFile = file => fs.readFileSync(file).toString();

app.use(bodyParser.urlencoded({ extended: false }));

app.use(bodyParser.json());

app.all('/save', (req, res) => {

    log('save');
    log(JSON.stringify(req.body));

    res.setHeader('Content-type', 'application/json; charset=utf-8');
    res.end(JSON.stringify({
        ok: true
    }));
})

app.all('/root', (req, res) => {

    const html  = readFile(path.resolve(__dirname, 'public', '_index.html'));

    const svg   = readFile(path.resolve(__dirname, 'public', 'tree.svg'));

    const tmp = template(html);

    res.end(tmp({
        svg
    }));
});

app.use(express.static(web, { // http://expressjs.com/en/resources/middleware/serve-static.html
    // maxAge: 60 * 60 * 24 * 1000 // in milliseconds
    maxAge: '356 days', // in milliseconds max-age=30758400
    setHeaders: (res, path) => {

        if (/\.bmp$/i.test(path)) { // for some reason by default express.static sets here Content-Type: image/x-ms-bmp

            res.setHeader('Content-type', 'image/bmp')
        }

        // https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control
        // res.setHeader('Cache-Control', 'public, no-cache, max-age=30758400')
        // res.setHeader('Cache-Control', 'public, only-if-cached')
    }
}), serveIndex(web, {'icons': true}));

app.listen(port, host, () => {

    console.log(`\n ðŸŒŽ  Server is running ` + `${host}:${port}\n`)
});
                </script>             
                <script type="editor" data-lang="json">
{
  "dependencies": {
    "body-parser": "^1.18.3",
    "express": "^4.16.3",
    "lodash": "^4.17.10",
    "serve-index": "^1.9.1"
  }
}
                
                </script> 
            </div>

            <div class="cards">
                <h2>update.sh - shell script</h2>  
                <a href="https://www.npmjs.com/package/colors">NPM - colors</a>
                <table width="100%">
                    <tbody>
                        <tr>
                            <td>
                <script type="editor" data-lang="js">
require('colors');
const l = c => console.log(`${c} [` + (`test string`[c]) + ']');
console.log("\n\n");
// text colors
l('black');
l('red');
l('green');
l('yellow');
l('blue');
l('magenta');
l('cyan');
l('white');
l('gray');
l('grey');
// bg colors
l('bgBlack');
l('bgRed');
l('bgGreen');
l('bgYellow');
l('bgBlue');
l('bgMagenta');
l('bgCyan');
l('bgWhite');
//styles
l('reset');
l('bold');
l('dim');
l('italic');
l('underline');
l('inverse');
l('hidden');
l('strikethrough');
//extras
l('rainbow');
l('zebra');
l('america');
l('trap');
l('random');
console.log("\n\n")                
                </script> 
                            </td>
                            <td width="257">
                                <img src="/img/node/colors.png" height="624"/>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>
