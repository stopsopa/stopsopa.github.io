<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>stopsopa.github.io</title>
    <script>
      (function () {
        var resolve;
        var p = new Promise(function (res) {
          resolve = res;
        });

        document.addEventListener("DOMContentLoaded", () => {
          Array.prototype.slice.call(document.querySelectorAll('[class="domain.com"]')).forEach(function (tag) {
            var text = tag.innerHTML;

            text = text.replace(/domain\.com/g, location.origin);

            tag.innerHTML = text;
          });

          resolve();
        });

        window.beforeAceEventPromise = function () {
          return p;
        };
      })();
    </script>
  </head>
  <body class="layout" toc>
    <div class="body">
      <div class="inside">
        <div class="cards">
          <h2>Images - Dockerfile</h2>
          <a href="./images.html">Images - Dockerfile</a>

          <h2>Useful commands</h2>
          <script type="editor" data-lang="sh">

            # -i
            # -t
            # running in pipelines without -t
            $ docker run --user $(id -u):$(id -g) -i image_name command args
            $ CURRENT_UID=$(id -u):$(id -g) docker-compose up

            docker history --format "\t{{.Size}}\t\t{{.CreatedBy}}" 1de239ccac3e --no-trunc

            # determine docker resources usage
            docker system df

            # determine image size
            docker system df -v | grep 695ab6fa12ce
                # to get IMAGE ID
                docker images | grep cypress/included

            docker image prune -a --force --filter "until=480h"
            docker system prune --all --volumes --force
                # from: https://docs.docker.com/config/pruning/
                # even more: https://www.digitalocean.com/community/tutorials/how-to-remove-docker-images-containers-and-volumes
            docker volume prune
              # pruning just volumes

            # print entrypoint of an image:
            docker inspect IMAGENAME | jq '.[0].ContainerConfig.Entrypoint[0]' -r
            docker image inspect IMAGENAME | jq '.[].Config.WorkingDir'

            docker container rm puppeteer-test -f
                # stop and remove container immediately

            DOCKER_BUILDKIT=1 docker build . --platform linux/amd64 -f docker/Dockerfile -t xxx:latest
                # https://github.com/docker/docker.github.io/issues/12231
            # passing env as is
            $ CYPRESS_VIDEO=false
            $ docker run --name name --rm -d -it -v $PWD:/e2e -w /e2e -e CYPRESS_VIDEO -e "PORT=8089" -p "8089:8089" --entrypoint="" cypress/included:3.2.0 node -v

            host.docker.internal
                # from: https://docs.docker.com/docker-for-mac/networking/#use-cases-and-workarounds
                g(Networking features in Docker Desktop for Mac Use cases and workarounds I WANT TO CONNECT FROM A CONTAINER TO A SERVICE ON THE HOST)
                # on linux you can use:
                    https://stackoverflow.com/a/48547074

            docker login https://docker-registry.xxx.com --username=yourhubusername --password=yourpassword

            # https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#build-an-image-using-a-dockerfile-from-stdin-without-sending-build-context
            # inline Dockerfile
            cat <<EOF | docker build --rm -t local_c7_systemd -
            FROM centos:7
            ...
            EOF

            docker run --rm -it local_c7_systemd bash

            # pushing image
            # nvm ls-remote
            docker run -it privaterepo.com/node:13.14.0-alpine sh
            docker pull node:13.14.0-alpine
            docker tag node:13.14.0-alpine privaterepo.com/node:13.14.0-alpine
            docker push privaterepo.com/node:13.14.0-alpine

            # run inline bash script in container
            # to run pod without stopping
            docker run -i --name test --rm -d alpine:3.14.2 tail -f /dev/null
            # then run script
            cat <<EOF | docker exec -i test /bin/sh
            echo a b c | awk '{print \$2}'
            EOF
            # or run as run straight away
            cat <<EOF | docker run -i --name test --rm alpine:3.14.2 /bin/sh
            echo a b c | awk '{print \$2}'
            EOF

            cat <<EOF | docker build --progress=plain -t project:node-multi_tl -
            FROM node:14.17.4-alpine AS base_stage
            RUN apk --no-cache add curl
            RUN apk update && apk upgrade && apk add curl
            ENV TEST_ENV="test..."
            ENTRYPOINT ["tail", "-f", "/dev/null"]
            EOF
            docker run -it project:node-multi_tl
            # if you need to restrict amount of memory or CPU power the
            # container can use, see
            # https://docs.docker.com/config/containers/resource_constraints/
            # restrict total memory
            # --memory=600m --memory-swap=600m
            # restrict CPU share
            # --cpus=0.3

            # checking healthcheck of container
            docker inspect --format "{{json .State.Health }}" cypress_app_container | jq
            # example of healtheck section in docker-compose (using 0s will not work for interval nor start_period, use 1s instead):
              healthcheck: # https://docs.docker.com/compose/compose-file/compose-file-v3/#healthcheck ANS https://docs.docker.com/engine/reference/builder/#healthcheck
                test: ["CMD", "node", "healthcheck.js"]
                start_period: 1s
                interval: 1s
                timeout: 5s
                retries: 3

            docker inspect cypress_app | grep -A 5 -B 5 RestartPolicy
              # based on https://docs.docker.com/config/containers/start-containers-automatically/
          </script>
          <h2>Docker Compose hostname</h2>
          <a href="https://stackoverflow.com/a/29926476/5560682">https://stackoverflow.com/a/29926476/5560682</a>
          <h2>docker-compose.yaml syntax</h2>
          <script type="editor" data-lang="sh">

            version: "3.8"
            services:
              mysql:
                build:
                  context: mysql
                  dockerfile: Dockerfile
                container_name: ${PROJECT_NAME}_mysql
                ports:
                  - "${MYSQL_PORT}:3306"
                environment:
                  MYSQL_ROOT_PASSWORD: ${MYSQL_PASS}
                  MYSQL_ROOT_HOST: "%"
                entrypoint: ""
                command: bash -c "
                    mkdir -p /var/lib/mysql_
                    &&
                    chown mysql:mysql /var/lib/mysql_
                    &&
                    /bin/bash /entrypoint.sh mysqld
                  "
          </script>
          <h2>Working with HOST MACHINE</h2>
          <script type="editor" data-lang="sh">

            How to communicate with service/server that lives on the host machine from within container
            # MAC
            # use from inside the host.docker.internal
            # more
            #     https://docs.docker.com/desktop/mac/networking/

            # LINUX
            # use --net=host in cli
            # also --add-host=host.docker.internal:host-gateway
            #        or
            #      --add-host host.docker.internal:host-gateway
            # more
            #     https://docs.docker.com/network/host/
            #     https://stackoverflow.com/a/24326540
          </script>

          <h2>Docker registry urls</h2>
          <script type="editor" data-lang="sh">

            https://domain.com/v2/_catalog
            https://domain.com/v2/username/appname/tags/list

            https://hub.docker.com/v2/search/repositories/?query=browserless

            https://hub.docker.com/v2/repositories/browserless
            https://hub.docker.com/v2/repositories/browserless/chrome/
            https://hub.docker.com/v2/repositories/browserless/chrome/tags

            ls -la /var/lib/docker/registry/docker/registry/v2/repositories
            # rm -rf /var/lib/docker/registry/docker/registry/v2/reposit...

            # removing image:
            curl -v --silent -H "authorization: Basic YWRta...akc=" -X DELETE https://docker-registry.domain.com/v2/puppeteer-1-20-0/manifests/sha256:ef75836309692....53dff9e325167
          </script>
          <h2>Ssh servers in docker</h2>
          <script type="editor" data-lang="sh">


# # first enter empty directory then
# mkdir pubkey
# cd pubkey
# ssh-keygen -t rsa -C admin@gmail.com
# # and provide ./id_rsa
# cd ..
# # add all below to run.sh and run it
# /bin/bash run.sh
# # then you can just run any of ssh -vvvvA methods below


docker stop ds1
docker stop ds2
docker stop ds3

# based on https://github.com/linuxserver/docker-openssh-server
# key added
docker run \
    --name ds1 \
    --rm \
    -d \
    -it \
    -e PUBLIC_KEY_FILE="/parent/pubkey/id_rsa.pub" \
    -e USER_NAME=user \
    -v "$(pwd)/:/parent" \
    -v "$(pwd)/ds1:/shared" \
    --workdir /shared \
    -p "4264:2222" \
    --name=ds1 \
    --hostname=ds1 \
    lscr.io/linuxserver/openssh-server:latest
# ssh -vvvvA -i ./pubkey/id_rsa -p 4264 user@0.0.0.0      
    
# key added    
docker run \
    --name ds2 \
    --rm \
    -d \
    -it \
    -e PUBLIC_KEY_FILE="/parent/pubkey/id_rsa.pub" \
    -e USER_NAME=user \
    -v "$(pwd)/:/parent" \
    -v "$(pwd)/ds2:/shared" \
    --workdir /shared \
    -p "4265:2222" \
    --name=ds2 \
    --hostname=ds2 \
    lscr.io/linuxserver/openssh-server:latest
# ssh -vvvvA -i ./pubkey/id_rsa -p 4265 user@0.0.0.0   
    
# key not added    
docker run \
    --name ds3 \
    --rm \
    -d \
    -it \
    -e USER_NAME=user \
    -v "$(pwd)/ds3:/shared" \
    --workdir /shared \
    -p "4266:2222" \
    --name=ds3 \
    --hostname=ds3 \
    lscr.io/linuxserver/openssh-server:latest
# ssh -vvvvA -i ./pubkey/id_rsa -p 4266 user@0.0.0.0   

    

# for HOST MACHINE
# tail -f ~/.ssh/known_hosts

# vi ~/.ssh/known_hosts
# Someone could be eavesdropping on you right now (man-in-the-middle attack)!
# It is also possible that a host key has just been changed.
# The fingerprint for the ED25519 key sent by the remote host is
# SHA256:53dmv2ssuMIHQmx8fkybQw45nGni5zvRQfSOf6gmX7U.
# Please contact your system administrator.
# Add correct host key in /Users/szdz/.ssh/known_hosts to get rid of this message.
# Offending ECDSA key in /Users/szdz/.ssh/known_hosts:7
# Host key for [0.0.0.0]:4265 has changed and you have requested strict checking.
# Host key verification failed.



docker ps

sleep 

docker ps

          </script>
          <a href="https://github.com/docker/distribution/blob/master/docs/spec/api.md#detail">https://github.com/docker/distribution/blob/master/docs/spec/api.md#detail</a>
          <a href="./listtags.html">List tags tool</a>

          <h2>Distroless images</h2>
          <a href="https://github.com/fluent/fluent-bit-docker-image/issues/19">https://github.com/fluent/fluent-bit-docker-image/issues/19</a>
          <h2>Images - Dockerfile</h2>
          <a href="https://github.com/moby/moby/issues/32868#issuecomment-297870441">About Multi-stage and Dockerfile syntax</a>
          <br />
          <a href="https://github.com/moby/moby/issues/32925">Origin of Buildkit</a>
          <h2>How docker generates names of containers</h2>
          <a href="https://github.com/moby/moby/blob/8bb58153e75b4310f3ae9ec6d03924aa286fbf20/pkg/namesgenerator/names-generator.go"
            >https://github.com/moby/moby/blob/8bb58153e75b4310f3ae9ec6d03924aa286fbf20/pkg/namesgenerator/names-generator.go</a
          >
        </div>
      </div>
    </div>
    <script src="/js/github.js"></script>
  </body>
</html>
